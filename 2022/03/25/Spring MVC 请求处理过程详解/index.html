

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon_ico.png">
  <link rel="icon" href="/img/favicon_ico.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="分享总结个人的学习路程">
  <meta name="author" content="屠雍">
  <meta name="keywords" content="PCB, 单片机, 物联网, 嵌入式, Java, Linux, Web前端">
  <meta name="description" content="Spring MVC 请求处理过程详解  SpringMVC请求处理相信大家都很熟悉了，本篇主要是基于SpringMVC处理请求的流程来阅读并调试源码，以及解决几个仅靠流程图无法解释的问题。  本篇使用的Spring版本为5.2.2.RELEASE  九大组件SpringMVC几乎所有的功能都由九大组件来完成，所以明白九大组件的作用，对于学习SpringMVC来说非常重要。 12345678910">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring MVC 请求处理过程详解">
<meta property="og:url" content="http://example.com/2022/03/25/Spring%20MVC%20%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="小贝比">
<meta property="og:description" content="Spring MVC 请求处理过程详解  SpringMVC请求处理相信大家都很熟悉了，本篇主要是基于SpringMVC处理请求的流程来阅读并调试源码，以及解决几个仅靠流程图无法解释的问题。  本篇使用的Spring版本为5.2.2.RELEASE  九大组件SpringMVC几乎所有的功能都由九大组件来完成，所以明白九大组件的作用，对于学习SpringMVC来说非常重要。 12345678910">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121548992.webp">
<meta property="og:image" content="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121548225.webp">
<meta property="og:image" content="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121549832.webp">
<meta property="og:image" content="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121549603.webp">
<meta property="og:image" content="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121550126.webp">
<meta property="og:image" content="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121551493.webp">
<meta property="og:image" content="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121551408.webp">
<meta property="og:image" content="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121551607.webp">
<meta property="og:image" content="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121552660.webp">
<meta property="og:image" content="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121552758.webp">
<meta property="article:published_time" content="2022-03-25T13:46:50.781Z">
<meta property="article:modified_time" content="2022-03-25T13:03:17.754Z">
<meta property="article:author" content="屠雍">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="SpringMVC">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121548992.webp">
  
  <title>Spring MVC 请求处理过程详解 - 小贝比</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/atom-one-dark.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>小贝比的个人博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/background7.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Spring MVC 请求处理过程详解">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-03-25 21:46" pubdate>
        2022年3月25日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      32k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      101 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Spring MVC 请求处理过程详解</h1>
            
            <div class="markdown-body">
              <center><h2>Spring MVC 请求处理过程详解</h2></center>

<p><code>SpringMVC</code>请求处理相信大家都很熟悉了，本篇主要是基于<code>SpringMVC</code>处理请求的流程来阅读并调试源码，以及解决几个仅靠流程图无法解释的问题。</p>
<blockquote>
<p>本篇使用的Spring版本为<code>5.2.2.RELEASE</code></p>
</blockquote>
<h2 id="九大组件"><a href="#九大组件" class="headerlink" title="九大组件"></a><strong>九大组件</strong></h2><p><code>SpringMVC</code>几乎所有的功能都由九大组件来完成，所以明白九大组件的作用，对于学习<code>SpringMVC</code>来说非常重要。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/** 文件上传解析器 */</span><br><span class="hljs-keyword">private</span> MultipartResolver multipartResolver;<br><br><span class="hljs-comment">/** 区域解析器，用于国际化 */</span><br><span class="hljs-keyword">private</span> LocaleResolver localeResolver;<br><br><span class="hljs-comment">/** 主题解析器 */</span><br><span class="hljs-keyword">private</span> ThemeResolver themeResolver;<br><br><span class="hljs-comment">/** Handler映射信息 */</span><br><span class="hljs-keyword">private</span> List&lt;HandlerMapping&gt; handlerMappings;<br><br><span class="hljs-comment">/** Handler适配器*/</span><br><span class="hljs-keyword">private</span> List&lt;HandlerAdapter&gt; handlerAdapters;<br><br><span class="hljs-comment">/** Handler执行异常解析器 */</span><br><span class="hljs-keyword">private</span> List&lt;HandlerExceptionResolver&gt; handlerExceptionResolvers;<br><br><span class="hljs-comment">/** 请求到视图的转换器 */</span><br><span class="hljs-keyword">private</span> RequestToViewNameTranslator viewNameTranslator;<br><br><span class="hljs-comment">/** SpringMVC允许重定向时携带参数，存在session中，用完就销毁，所以叫FlashMap */</span><br><span class="hljs-keyword">private</span> FlashMapManager flashMapManager;<br><br><span class="hljs-comment">/** 视图解析器 */</span><br><span class="hljs-keyword">private</span> List&lt;ViewResolver&gt; viewResolvers;<br></code></pre></div></td></tr></table></figure>

<ul>
<li><code>HandlerMapping</code>：<code>Handler</code>映射信息，根据请求携带的url信息查找处理器（<code>Handler</code>）。每个请求都需要对应的<code>Handler</code>处理。</li>
<li><code>HandlerAdapter</code>：<code>Handler</code>适配器，<code>SpringMVC</code>没有直接调用处理器（<code>Handler</code>），而是通过<code>HandlerAdapter</code>来调用，主要是为了统一<code>Handler</code>的调用方式</li>
<li><code>ViewResolver</code>：视图解析器，用来将字符串类型的视图名称解析为<code>View</code>类型的视图。<code>ViewResolver</code>需要找到渲染所用的模板和所用的技术（也就是视图的类型）进行渲染，具体的渲染过程则交由不同的视图自己完成。</li>
<li><code>MultipartResolver</code>：文件上传解析器，主要用来处理文件上传请求</li>
<li><code>HandlerExceptionResolver</code>：Handler执行异常解析器，用来对异常进行统一处理</li>
<li><code>RequestToViewNameTranslator</code>：请求到视图的转换器</li>
<li><code>LocaleResolver</code>：区域解析器，用于支持国际化</li>
<li><code>FlashMapManager</code>：<code>SpringMVC</code>允许重定向时携带参数，存在<code>session</code>中，用完就销毁，所以叫<code>FlashMap</code></li>
<li><code>ThemeResolver</code>：主题解析器，用于支持不同的主题</li>
</ul>
<p>九大组件中最重的的前三个，<code>HandlerMapping</code>、<code>HandlerAdapter</code>和<code>ViewResolver</code>，因为这是阅读源码时，避不开的三个组件。</p>
<h2 id="调试准备"><a href="#调试准备" class="headerlink" title="调试准备"></a><strong>调试准备</strong></h2><p>搭建一个基本的<code>Spring web</code>项目即可</p>
<h3 id="Controller部分"><a href="#Controller部分" class="headerlink" title="Controller部分"></a>Controller部分</h3><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IndexController</span> </span>&#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/index/home&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">home</span><span class="hljs-params">(String id, Student student, <span class="hljs-meta">@RequestParam(&quot;code&quot;)</span> String code)</span> </span>&#123;<br>        System.out.println(student.getName());<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;index&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/index/list&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">list</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>



<h3 id="Entity部分"><a href="#Entity部分" class="headerlink" title="Entity部分"></a>Entity部分</h3><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Integer gender;<br><br>   <span class="hljs-comment">// getter、setter</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>还是那句话，<code>Spring</code>源码非常庞大，不能只见树木不见森林，需要有针对性的阅读，所以本篇只需要关注主体流程即可。</p>
<h2 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a><strong>核心方法</strong></h2><p>我们都知道，<code>SpringMVC</code>有一个用来分发请求的前端控制器<code>DispatcherServlet</code>，其中用来处理请求的方法就是<code>doService</code>，该方法定义如下</p>
<h3 id="doService"><a href="#doService" class="headerlink" title="doService"></a><strong>doService</strong></h3><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Exposes the DispatcherServlet-specific request attributes and delegates to &#123;<span class="hljs-doctag">@link</span> #doDispatch&#125;</span><br><span class="hljs-comment"> * for the actual dispatching.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doService</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br> logRequest(request);<br><br> <span class="hljs-comment">// Keep a snapshot of the request attributes in case of an include,</span><br> <span class="hljs-comment">// to be able to restore the original attributes after the include.</span><br> Map&lt;String, Object&gt; attributesSnapshot = <span class="hljs-keyword">null</span>;<br> <span class="hljs-keyword">if</span> (WebUtils.isIncludeRequest(request)) &#123;<br>  attributesSnapshot = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>  Enumeration&lt;?&gt; attrNames = request.getAttributeNames();<br>  <span class="hljs-keyword">while</span> (attrNames.hasMoreElements()) &#123;<br>   String attrName = (String) attrNames.nextElement();<br>   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cleanupAfterInclude || attrName.startsWith(DEFAULT_STRATEGIES_PREFIX)) &#123;<br>    attributesSnapshot.put(attrName, request.getAttribute(attrName));<br>   &#125;<br>  &#125;<br> &#125;<br><br> <span class="hljs-comment">// Make framework objects available to handlers and view objects.</span><br> request.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());<br> request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, <span class="hljs-keyword">this</span>.localeResolver);<br> request.setAttribute(THEME_RESOLVER_ATTRIBUTE, <span class="hljs-keyword">this</span>.themeResolver);<br> request.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());<br><br> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.flashMapManager != <span class="hljs-keyword">null</span>) &#123;<br>  FlashMap inputFlashMap = <span class="hljs-keyword">this</span>.flashMapManager.retrieveAndUpdate(request, response);<br>  <span class="hljs-keyword">if</span> (inputFlashMap != <span class="hljs-keyword">null</span>) &#123;<br>   request.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));<br>  &#125;<br>  request.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, <span class="hljs-keyword">new</span> FlashMap());<br>  request.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, <span class="hljs-keyword">this</span>.flashMapManager);<br> &#125;<br><br> <span class="hljs-keyword">try</span> &#123;<br>  <span class="hljs-comment">// 真正执行的方法</span><br>  doDispatch(request, response);<br> &#125;<br> <span class="hljs-keyword">finally</span> &#123;<br>  <span class="hljs-keyword">if</span> (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;<br>   <span class="hljs-comment">// Restore the original attribute snapshot, in case of an include.</span><br>   <span class="hljs-keyword">if</span> (attributesSnapshot != <span class="hljs-keyword">null</span>) &#123;<br>    restoreAttributesAfterInclude(request, attributesSnapshot);<br>   &#125;<br>  &#125;<br> &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="doDispatch"><a href="#doDispatch" class="headerlink" title="doDispatch"></a>doDispatch</h3><p><code>doDispatch</code>是<code>doService</code>中真正用来处理请求的方法</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 实际处理请求的方法</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doDispatch</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br> HttpServletRequest processedRequest = request;<br> HandlerExecutionChain mappedHandler = <span class="hljs-keyword">null</span>;<br> <span class="hljs-keyword">boolean</span> multipartRequestParsed = <span class="hljs-keyword">false</span>;<br><br> WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);<br><br> <span class="hljs-keyword">try</span> &#123;<br>  ModelAndView mv = <span class="hljs-keyword">null</span>;<br>  Exception dispatchException = <span class="hljs-keyword">null</span>;<br><br>  <span class="hljs-keyword">try</span> &#123;<br>   <span class="hljs-comment">// 校验是否是文件上传请求</span><br>   processedRequest = checkMultipart(request);<br>   multipartRequestParsed = (processedRequest != request);<br><br>   <span class="hljs-comment">// Determine handler for the current request.</span><br>   <span class="hljs-comment">// 为当前请求找到一个合适的处理器（Handler）</span><br>   <span class="hljs-comment">// 返回值是一个HandlerExecutionChain，也就是处理器执行链</span><br>   mappedHandler = getHandler(processedRequest);<br>   <span class="hljs-keyword">if</span> (mappedHandler == <span class="hljs-keyword">null</span>) &#123;<br>    noHandlerFound(processedRequest, response);<br>    <span class="hljs-keyword">return</span>;<br>   &#125;<br><br>   <span class="hljs-comment">// Determine handler adapter for the current request.</span><br>   <span class="hljs-comment">// 根据HandlerExecutionChain携带的Handler找到合适的HandlerAdapter</span><br>   HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());<br><br>   <span class="hljs-comment">// Process last-modified header, if supported by the handler.</span><br>   <span class="hljs-comment">// 处理GET请求的缓存</span><br>   String method = request.getMethod();<br>   <span class="hljs-keyword">boolean</span> isGet = <span class="hljs-string">&quot;GET&quot;</span>.equals(method);<br>   <span class="hljs-keyword">if</span> (isGet || <span class="hljs-string">&quot;HEAD&quot;</span>.equals(method)) &#123;<br>    <span class="hljs-keyword">long</span> lastModified = ha.getLastModified(request, mappedHandler.getHandler());<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;<br>     <span class="hljs-keyword">return</span>;<br>    &#125;<br>   &#125;<br><br>   <span class="hljs-comment">// 执行拦截器的preHandle方法</span><br>   <span class="hljs-keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;<br>    <span class="hljs-keyword">return</span>;<br>   &#125;<br><br>   <span class="hljs-comment">// Actually invoke the handler.</span><br>   <span class="hljs-comment">// 利用HandlerAdapter来执行Handler里对应的处理方法</span><br>   mv = ha.handle(processedRequest, response, mappedHandler.getHandler());<br><br>   <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;<br>    <span class="hljs-keyword">return</span>;<br>   &#125;<br><br>   <span class="hljs-comment">// 如果没有设置视图，则应用默认的视图名</span><br>   applyDefaultViewName(processedRequest, mv);<br>   <span class="hljs-comment">// 执行拦截器的postHandle方法</span><br>   mappedHandler.applyPostHandle(processedRequest, response, mv);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>   dispatchException = ex;<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Throwable err) &#123;<br>   <span class="hljs-comment">// As of 4.3, we&#x27;re processing Errors thrown from handler methods as well,</span><br>   <span class="hljs-comment">// making them available for @ExceptionHandler methods and other scenarios.</span><br>   dispatchException = <span class="hljs-keyword">new</span> NestedServletException(<span class="hljs-string">&quot;Handler dispatch failed&quot;</span>, err);<br>  &#125;<br>  <span class="hljs-comment">// 根据ModelAndView对象解析视图</span><br>  processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);<br> &#125;<br> <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>  triggerAfterCompletion(processedRequest, response, mappedHandler, ex);<br> &#125;<br> <span class="hljs-keyword">catch</span> (Throwable err) &#123;<br>  triggerAfterCompletion(processedRequest, response, mappedHandler,<br>    <span class="hljs-keyword">new</span> NestedServletException(<span class="hljs-string">&quot;Handler processing failed&quot;</span>, err));<br> &#125;<br> <span class="hljs-keyword">finally</span> &#123;<br>  <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;<br>   <span class="hljs-comment">// Instead of postHandle and afterCompletion</span><br>   <span class="hljs-keyword">if</span> (mappedHandler != <span class="hljs-keyword">null</span>) &#123;<br>    mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);<br>   &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>   <span class="hljs-comment">// Clean up any resources used by a multipart request.</span><br>   <span class="hljs-keyword">if</span> (multipartRequestParsed) &#123;<br>    cleanupMultipart(processedRequest);<br>   &#125;<br>  &#125;<br> &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>该方法就是<code>SpringMVC</code>处理请求的整体流程，其中涉及到几个重要的方法。</p>
<h3 id="getHandler"><a href="#getHandler" class="headerlink" title="getHandler"></a>getHandler</h3><p>该方法定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Return the HandlerExecutionChain for this request.</span><br><span class="hljs-comment"> * 为这个request返回一个HandlerExecutionChain</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> HandlerExecutionChain <span class="hljs-title">getHandler</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.handlerMappings != <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-keyword">for</span> (HandlerMapping mapping : <span class="hljs-keyword">this</span>.handlerMappings) &#123;<br>   HandlerExecutionChain handler = mapping.getHandler(request);<br>   <span class="hljs-keyword">if</span> (handler != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> handler;<br>   &#125;<br>  &#125;<br> &#125;<br> <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>



<p>调试信息如下</p>
<p><img src="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121548992.webp" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>根据调试信息可以看出，<code>getHandler</code>方法主要是从<code>List&lt;HandlerMapping&gt; handlerMappings</code>集合中遍历查找一个合适的处理器（<code>Handler</code>），返回的结果是一个<code>HandlerExecutionChain</code>。然后再根据<code>HandlerExecutionChain</code>里携带的<code>Handler</code>去获取<code>HandlerAdapter</code>。</p>
<h3 id="getHandlerAdapter"><a href="#getHandlerAdapter" class="headerlink" title="getHandlerAdapter"></a>getHandlerAdapter</h3><p><code>getHandlerAdapter</code>方法定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Return the HandlerAdapter for this handler object.</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> handler the handler object to find an adapter for</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@throws</span> ServletException if no HandlerAdapter can be found for the handler. This is a fatal error.</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-function"><span class="hljs-keyword">protected</span> HandlerAdapter <span class="hljs-title">getHandlerAdapter</span><span class="hljs-params">(Object handler)</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.handlerAdapters != <span class="hljs-keyword">null</span>) &#123;<br>   <span class="hljs-keyword">for</span> (HandlerAdapter adapter : <span class="hljs-keyword">this</span>.handlerAdapters) &#123;<br>    <span class="hljs-keyword">if</span> (adapter.supports(handler)) &#123;<br>     <span class="hljs-keyword">return</span> adapter;<br>    &#125;<br>   &#125;<br>  &#125;<br>  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ServletException(<span class="hljs-string">&quot;No adapter for handler [&quot;</span> + handler +<br>    <span class="hljs-string">&quot;]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler&quot;</span>);<br> &#125;<br></code></pre></div></td></tr></table></figure>

<p>调试信息如下</p>
<p><img src="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121548225.webp" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>同样<code>getHandlerAdapter</code>方法主要是从<code>List&lt;HandlerAdapter&gt; handlerAdapters</code>集合中遍历查找一个合适的处理器适配器（<code>HandlerAdapter</code>），返回的结果是一个<code>HandlerAdapter</code>。</p>
<p>可以看到此处<code>HandlerAdapter</code>真正的实现类是<code>RequestMappingHandlerAdapter</code>。</p>
<h3 id="processDispatchResult"><a href="#processDispatchResult" class="headerlink" title="processDispatchResult"></a>processDispatchResult</h3><p><code>processDispatchResult</code>方法主要根据方法执行完成后封装的<code>ModelAndView</code>，转发到对应页面，定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Handle the result of handler selection and handler invocation, which is</span><br><span class="hljs-comment"> * either a ModelAndView or an Exception to be resolved to a ModelAndView.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processDispatchResult</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-meta">@Nullable</span> HandlerExecutionChain mappedHandler, <span class="hljs-meta">@Nullable</span> ModelAndView mv,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-meta">@Nullable</span> Exception exception)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br> <span class="hljs-keyword">boolean</span> errorView = <span class="hljs-keyword">false</span>;<br><br> <span class="hljs-keyword">if</span> (exception != <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> ModelAndViewDefiningException) &#123;<br>   logger.debug(<span class="hljs-string">&quot;ModelAndViewDefiningException encountered&quot;</span>, exception);<br>   mv = ((ModelAndViewDefiningException) exception).getModelAndView();<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>   Object handler = (mappedHandler != <span class="hljs-keyword">null</span> ? mappedHandler.getHandler() : <span class="hljs-keyword">null</span>);<br>   mv = processHandlerException(request, response, handler, exception);<br>   errorView = (mv != <span class="hljs-keyword">null</span>);<br>  &#125;<br> &#125;<br><br> <span class="hljs-comment">// Did the handler return a view to render?</span><br> <span class="hljs-keyword">if</span> (mv != <span class="hljs-keyword">null</span> &amp;&amp; !mv.wasCleared()) &#123;<br>  <span class="hljs-comment">// 主要调用该方法渲染视图</span><br>  render(mv, request, response);<br>  <span class="hljs-keyword">if</span> (errorView) &#123;<br>   WebUtils.clearErrorRequestAttributes(request);<br>  &#125;<br> &#125;<br> <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>   logger.trace(<span class="hljs-string">&quot;No view rendering, null ModelAndView returned.&quot;</span>);<br>  &#125;<br> &#125;<br><br> <span class="hljs-keyword">if</span> (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;<br>  <span class="hljs-comment">// Concurrent handling started during a forward</span><br>  <span class="hljs-keyword">return</span>;<br> &#125;<br><br> <span class="hljs-keyword">if</span> (mappedHandler != <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-comment">// Exception (if any) is already handled..</span><br>  mappedHandler.triggerAfterCompletion(request, response, <span class="hljs-keyword">null</span>);<br> &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="render"><a href="#render" class="headerlink" title="render"></a>render</h3><p><code>render</code>方法定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Render the given ModelAndView.</span><br><span class="hljs-comment"> * &lt;p&gt;This is the last stage in handling a request. It may involve resolving the view by name.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> mv the ModelAndView to render</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> request current HTTP servlet request</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> response current HTTP servlet response</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> ServletException if view is missing or cannot be resolved</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception if there&#x27;s a problem rendering the view</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">render</span><span class="hljs-params">(ModelAndView mv, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br> <span class="hljs-comment">// Determine locale for request and apply it to the response.</span><br> Locale locale =<br>   (<span class="hljs-keyword">this</span>.localeResolver != <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">this</span>.localeResolver.resolveLocale(request) : request.getLocale());<br> response.setLocale(locale);<br><br> View view;<br> String viewName = mv.getViewName();<br> <span class="hljs-keyword">if</span> (viewName != <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-comment">// We need to resolve the view name.</span><br>  <span class="hljs-comment">// 根据给定的视图名称，解析获取View对象</span><br>  view = resolveViewName(viewName, mv.getModelInternal(), locale, request);<br>  <span class="hljs-keyword">if</span> (view == <span class="hljs-keyword">null</span>) &#123;<br>   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ServletException(<span class="hljs-string">&quot;Could not resolve view with name &#x27;&quot;</span> + mv.getViewName() +<br>     <span class="hljs-string">&quot;&#x27; in servlet with name &#x27;&quot;</span> + getServletName() + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>  &#125;<br> &#125;<br> <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// No need to lookup: the ModelAndView object contains the actual View object.</span><br>  view = mv.getView();<br>  <span class="hljs-keyword">if</span> (view == <span class="hljs-keyword">null</span>) &#123;<br>   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ServletException(<span class="hljs-string">&quot;ModelAndView [&quot;</span> + mv + <span class="hljs-string">&quot;] neither contains a view name nor a &quot;</span> +<br>     <span class="hljs-string">&quot;View object in servlet with name &#x27;&quot;</span> + getServletName() + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>  &#125;<br> &#125;<br><br> <span class="hljs-comment">// Delegate to the View object for rendering.</span><br> <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>  logger.trace(<span class="hljs-string">&quot;Rendering view [&quot;</span> + view + <span class="hljs-string">&quot;] &quot;</span>);<br> &#125;<br> <span class="hljs-keyword">try</span> &#123;<br>  <span class="hljs-keyword">if</span> (mv.getStatus() != <span class="hljs-keyword">null</span>) &#123;<br>   response.setStatus(mv.getStatus().value());<br>  &#125;<br>  view.render(mv.getModelInternal(), request, response);<br> &#125;<br> <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>  <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>   logger.debug(<span class="hljs-string">&quot;Error rendering view [&quot;</span> + view + <span class="hljs-string">&quot;]&quot;</span>, ex);<br>  &#125;<br>  <span class="hljs-keyword">throw</span> ex;<br> &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="resolveViewName"><a href="#resolveViewName" class="headerlink" title="resolveViewName"></a>resolveViewName</h3><p><code>resolveViewName</code>方法定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> View <span class="hljs-title">resolveViewName</span><span class="hljs-params">(String viewName, <span class="hljs-meta">@Nullable</span> Map&lt;String, Object&gt; model,</span></span><br><span class="hljs-params"><span class="hljs-function">  Locale locale, HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.viewResolvers != <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-keyword">for</span> (ViewResolver viewResolver : <span class="hljs-keyword">this</span>.viewResolvers) &#123;<br>   View view = viewResolver.resolveViewName(viewName, locale);<br>   <span class="hljs-keyword">if</span> (view != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> view;<br>   &#125;<br>  &#125;<br> &#125;<br> <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>调试信息如下</p>
<p><img src="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121549832.webp" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>根据调试信息可以看到真正解析视图的<code>ViewResolver</code>的是<code>InternalResourceViewResolver</code>类，也就是我们经常配置的一项类型</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 定义视图文件解析 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;prefix&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/WEB-INF/views/&quot;</span> /&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;suffix&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;.html&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<p>至此我们就得到了<code>SpringMVC</code>处理请求的完整逻辑</p>
<p><img src="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121549603.webp" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p><code>SpringMVC</code>处理请求的整个流程已经梳理清楚了。</p>
<p>但是，有两个重要的问题没有解决，那就是：参数绑定和返回值处理。</p>
<p>&gt; 因为在编写Controller里面的方法的时候，各种类型的参数都有，SpringMVC是怎么处理不同类型的参数的呢？<br>&gt; SpringMVC处理请求完成后，一定会返回<code>ModelAndView</code>吗，如果加了<code>@ResponseBody</code>注解呢？</p>
<h2 id="参数绑定"><a href="#参数绑定" class="headerlink" title="参数绑定"></a><strong>参数绑定</strong></h2><p>在整个流程中，还有一个最重要的方法，那就是真正执行<code>handler</code>的方法，参数的绑定和返回值的处理都在这个方法里，也就是</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// Actually invoke the handler.</span><br>mv = ha.handle(processedRequest, response, mappedHandler.getHandler());<br></code></pre></div></td></tr></table></figure>

<h3 id="handle"><a href="#handle" class="headerlink" title="handle"></a>handle</h3><p><code>handle</code>方法的作用是根据请求参数，执行真正的处理方法，并且返回合适的<code>ModelAndView</code>对象，也有可能返回<code>null</code>。该方法定义如下<br>在<code>AbstractHandlerMethodAdapter</code>类中</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * This implementation expects the handler to be an &#123;<span class="hljs-doctag">@link</span> HandlerMethod&#125;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ModelAndView <span class="hljs-title">handle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span><br><span class="hljs-function">  <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br> <span class="hljs-keyword">return</span> handleInternal(request, response, (HandlerMethod) handler);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>可以看到这个方法实现只有一行代码</p>
<h3 id="handleInternal"><a href="#handleInternal" class="headerlink" title="handleInternal"></a>handleInternal</h3><p>继续深入<code>handleInternal</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> ModelAndView <span class="hljs-title">handleInternal</span><span class="hljs-params">(HttpServletRequest request,</span></span><br><span class="hljs-params"><span class="hljs-function">  HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br> ModelAndView mav;<br> <span class="hljs-comment">// 校验指定的请求以获取受支持的方法类型（GET、POST等）和所需的session</span><br> checkRequest(request);<br><br> <span class="hljs-comment">// Execute invokeHandlerMethod in synchronized block if required.</span><br> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.synchronizeOnSession) &#123;<br>  HttpSession session = request.getSession(<span class="hljs-keyword">false</span>);<br>  <span class="hljs-keyword">if</span> (session != <span class="hljs-keyword">null</span>) &#123;<br>   Object mutex = WebUtils.getSessionMutex(session);<br>   <span class="hljs-keyword">synchronized</span> (mutex) &#123;<br>    mav = invokeHandlerMethod(request, response, handlerMethod);<br>   &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>   <span class="hljs-comment">// No HttpSession available -&gt; no mutex necessary</span><br>   mav = invokeHandlerMethod(request, response, handlerMethod);<br>  &#125;<br> &#125;<br> <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// No synchronization on session demanded at all...</span><br>  <span class="hljs-comment">// 真正执行handler的方法</span><br>  mav = invokeHandlerMethod(request, response, handlerMethod);<br> &#125;<br><br> <span class="hljs-keyword">if</span> (!response.containsHeader(HEADER_CACHE_CONTROL)) &#123;<br>  <span class="hljs-keyword">if</span> (getSessionAttributesHandler(handlerMethod).hasSessionAttributes()) &#123;<br>   applyCacheSeconds(response, <span class="hljs-keyword">this</span>.cacheSecondsForSessionAttributeHandlers);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>   prepareResponse(response);<br>  &#125;<br> &#125;<br><br> <span class="hljs-keyword">return</span> mav;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="invokeHandlerMethod"><a href="#invokeHandlerMethod" class="headerlink" title="invokeHandlerMethod"></a>invokeHandlerMethod</h3><p>继续深入<code>invokeHandlerMethod</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Invoke the &#123;<span class="hljs-doctag">@link</span> RequestMapping&#125; handler method preparing a &#123;<span class="hljs-doctag">@link</span> ModelAndView&#125;</span><br><span class="hljs-comment"> * if view resolution is required.</span><br><span class="hljs-comment"> * 执行<span class="hljs-doctag">@RequestMapping</span>标注的handler方法，如果需要解析视图就准备一个ModelAndView</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> ModelAndView <span class="hljs-title">invokeHandlerMethod</span><span class="hljs-params">(HttpServletRequest request,</span></span><br><span class="hljs-params"><span class="hljs-function">  HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br> ServletWebRequest webRequest = <span class="hljs-keyword">new</span> ServletWebRequest(request, response);<br> <span class="hljs-keyword">try</span> &#123;<br>  WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);<br>  ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);<br><br>  <span class="hljs-comment">// HandlerMethod接口封装执行方法的信息，提供对方法参数，方法返回值，方法注释等的便捷访问。</span><br>  ServletInvocableHandlerMethod invocableMethod = createInvocableHandlerMethod(handlerMethod);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.argumentResolvers != <span class="hljs-keyword">null</span>) &#123;<br>   invocableMethod.setHandlerMethodArgumentResolvers(<span class="hljs-keyword">this</span>.argumentResolvers);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.returnValueHandlers != <span class="hljs-keyword">null</span>) &#123;<br>   invocableMethod.setHandlerMethodReturnValueHandlers(<span class="hljs-keyword">this</span>.returnValueHandlers);<br>  &#125;<br>  invocableMethod.setDataBinderFactory(binderFactory);<br>  invocableMethod.setParameterNameDiscoverer(<span class="hljs-keyword">this</span>.parameterNameDiscoverer);<br><br>  <span class="hljs-comment">// ModelAndViewContainer可以看做ModelAndView的上下文容器，关联着Model和View的信息</span><br>  ModelAndViewContainer mavContainer = <span class="hljs-keyword">new</span> ModelAndViewContainer();<br>  mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));<br>  modelFactory.initModel(webRequest, mavContainer, invocableMethod);<br>  mavContainer.setIgnoreDefaultModelOnRedirect(<span class="hljs-keyword">this</span>.ignoreDefaultModelOnRedirect);<br><br>  AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);<br>  asyncWebRequest.setTimeout(<span class="hljs-keyword">this</span>.asyncRequestTimeout);<br><br>  WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);<br>  asyncManager.setTaskExecutor(<span class="hljs-keyword">this</span>.taskExecutor);<br>  asyncManager.setAsyncWebRequest(asyncWebRequest);<br>  asyncManager.registerCallableInterceptors(<span class="hljs-keyword">this</span>.callableInterceptors);<br>  asyncManager.registerDeferredResultInterceptors(<span class="hljs-keyword">this</span>.deferredResultInterceptors);<br><br>  <span class="hljs-keyword">if</span> (asyncManager.hasConcurrentResult()) &#123;<br>   Object result = asyncManager.getConcurrentResult();<br>   mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class="hljs-number">0</span>];<br>   asyncManager.clearConcurrentResult();<br>   LogFormatUtils.traceDebug(logger, traceOn -&gt; &#123;<br>    String formatted = LogFormatUtils.formatValue(result, !traceOn);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Resume with async result [&quot;</span> + formatted + <span class="hljs-string">&quot;]&quot;</span>;<br>   &#125;);<br>   invocableMethod = invocableMethod.wrapConcurrentResult(result);<br>  &#125;<br><br>  <span class="hljs-comment">// 真正执行Handler的方法</span><br>  invocableMethod.invokeAndHandle(webRequest, mavContainer);<br>  <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;<br>   <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// 获取ModelAndeView对象</span><br>  <span class="hljs-keyword">return</span> getModelAndView(mavContainer, modelFactory, webRequest);<br> &#125;<br> <span class="hljs-keyword">finally</span> &#123;<br>  webRequest.requestCompleted();<br> &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p><strong>invokeAndHandle</strong></p>
<p><code>invokeAndHandle</code>方法的作用是执行并处理真正响应请求的方法，该方法定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Invoke the method and handle the return value through one of the</span><br><span class="hljs-comment"> * configured &#123;<span class="hljs-doctag">@link</span> HandlerMethodReturnValueHandler HandlerMethodReturnValueHandlers&#125;.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> webRequest the current request</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> mavContainer the ModelAndViewContainer for this request</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> providedArgs &quot;given&quot; arguments matched by type (not resolved)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeAndHandle</span><span class="hljs-params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span></span><br><span class="hljs-params"><span class="hljs-function">  Object... providedArgs)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br> <span class="hljs-comment">// 执行handler的方法</span><br> Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);<br> setResponseStatus(webRequest);<br><br> <span class="hljs-keyword">if</span> (returnValue == <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-keyword">if</span> (isRequestNotModified(webRequest) || getResponseStatus() != <span class="hljs-keyword">null</span> || mavContainer.isRequestHandled()) &#123;<br>   disableContentCachingIfNecessary(webRequest);<br>   mavContainer.setRequestHandled(<span class="hljs-keyword">true</span>);<br>   <span class="hljs-keyword">return</span>;<br>  &#125;<br> &#125;<br> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.hasText(getResponseStatusReason())) &#123;<br>  mavContainer.setRequestHandled(<span class="hljs-keyword">true</span>);<br>  <span class="hljs-keyword">return</span>;<br> &#125;<br><br> mavContainer.setRequestHandled(<span class="hljs-keyword">false</span>);<br> Assert.state(<span class="hljs-keyword">this</span>.returnValueHandlers != <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;No return value handlers&quot;</span>);<br> <span class="hljs-keyword">try</span> &#123;<br>  <span class="hljs-keyword">this</span>.returnValueHandlers.handleReturnValue(<br>    returnValue, getReturnValueType(returnValue), mavContainer, webRequest);<br> &#125;<br> <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>  <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>   logger.trace(formatErrorForReturnValue(returnValue), ex);<br>  &#125;<br>  <span class="hljs-keyword">throw</span> ex;<br> &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="invokeForRequest"><a href="#invokeForRequest" class="headerlink" title="invokeForRequest"></a>invokeForRequest</h3><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Invoke the method after resolving its argument values in the context of the given request.</span><br><span class="hljs-comment"> * &lt;p&gt;Argument values are commonly resolved through</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> HandlerMethodArgumentResolver HandlerMethodArgumentResolvers&#125;.</span><br><span class="hljs-comment"> * The &#123;<span class="hljs-doctag">@code</span> providedArgs&#125; parameter however may supply argument values to be used directly,</span><br><span class="hljs-comment"> * i.e. without argument resolution. Examples of provided argument values include a</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> WebDataBinder&#125;, a &#123;<span class="hljs-doctag">@link</span> SessionStatus&#125;, or a thrown exception instance.</span><br><span class="hljs-comment"> * Provided argument values are checked before argument resolvers.</span><br><span class="hljs-comment"> * &lt;p&gt;Delegates to &#123;<span class="hljs-doctag">@link</span> #getMethodArgumentValues&#125; and calls &#123;<span class="hljs-doctag">@link</span> #doInvoke&#125; with the</span><br><span class="hljs-comment"> * resolved arguments.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> request the current request</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> mavContainer the ModelAndViewContainer for this request</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> providedArgs &quot;given&quot; arguments matched by type, not resolved</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the raw value returned by the invoked method</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception raised if no suitable argument resolver can be found,</span><br><span class="hljs-comment"> * or if the method raised an exception</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> #getMethodArgumentValues</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> #doInvoke</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invokeForRequest</span><span class="hljs-params">(NativeWebRequest request, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span><br><span class="hljs-params"><span class="hljs-function">  Object... providedArgs)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br> <span class="hljs-comment">// 获取参数</span><br> Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);<br> <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>  logger.trace(<span class="hljs-string">&quot;Arguments: &quot;</span> + Arrays.toString(args));<br> &#125;<br> <span class="hljs-comment">// 执行</span><br> <span class="hljs-keyword">return</span> doInvoke(args);<br>&#125;<br></code></pre></div></td></tr></table></figure>



<p>真正的执行无非就是通过反射<code>invoke</code>，所以更重要的是参数是如何绑定的，详情就在<code>getMethodArgumentValues</code>方法</p>
<h3 id="getMethodArgumentValues"><a href="#getMethodArgumentValues" class="headerlink" title="getMethodArgumentValues"></a>getMethodArgumentValues</h3><p><code>getMethodArgumentValues</code>方法用于从<code>request</code>请求中获取真正的参数，返回的是<code>Object</code>数组，该方法定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Get the method argument values for the current request, checking the provided</span><br><span class="hljs-comment"> * argument values and falling back to the configured argument resolvers.</span><br><span class="hljs-comment"> * &lt;p&gt;The resulting array will be passed into &#123;<span class="hljs-doctag">@link</span> #doInvoke&#125;.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 5.1.2</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> Object[] getMethodArgumentValues(NativeWebRequest request, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer,<br>  Object... providedArgs) <span class="hljs-keyword">throws</span> Exception &#123;<br><br> <span class="hljs-comment">// 获取方法上所有的参数</span><br> MethodParameter[] parameters = getMethodParameters();<br> <span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(parameters)) &#123;<br>  <span class="hljs-keyword">return</span> EMPTY_ARGS;<br> &#125;<br><br> Object[] args = <span class="hljs-keyword">new</span> Object[parameters.length];<br> <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; parameters.length; i++) &#123;<br>  MethodParameter parameter = parameters[i];<br>  parameter.initParameterNameDiscovery(<span class="hljs-keyword">this</span>.parameterNameDiscoverer);<br>  args[i] = findProvidedArgument(parameter, providedArgs);<br>  <span class="hljs-keyword">if</span> (args[i] != <span class="hljs-keyword">null</span>) &#123;<br>   <span class="hljs-keyword">continue</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.resolvers.supportsParameter(parameter)) &#123;<br>   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(formatArgumentError(parameter, <span class="hljs-string">&quot;No suitable resolver&quot;</span>));<br>  &#125;<br>  <span class="hljs-keyword">try</span> &#123;<br>   <br>   args[i] = <span class="hljs-keyword">this</span>.resolvers.resolveArgument(parameter, mavContainer, request, <span class="hljs-keyword">this</span>.dataBinderFactory);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>   <span class="hljs-comment">// Leave stack trace for later, exception may actually be resolved and handled...</span><br>   <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>    String exMsg = ex.getMessage();<br>    <span class="hljs-keyword">if</span> (exMsg != <span class="hljs-keyword">null</span> &amp;&amp; !exMsg.contains(parameter.getExecutable().toGenericString())) &#123;<br>     logger.debug(formatArgumentError(parameter, exMsg));<br>    &#125;<br>   &#125;<br>   <span class="hljs-keyword">throw</span> ex;<br>  &#125;<br> &#125;<br> <span class="hljs-keyword">return</span> args;<br>&#125;<br></code></pre></div></td></tr></table></figure>



<p><img src="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121550126.webp" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>根据调试信息可以看到，用来处理请求参数的类是<code>HandlerMethodArgumentResolver</code>接口的实现类<code>HandlerMethodArgumentResolverComposite</code>，此时正在处理的参数是一个<code>Student</code>对象，并且已经把值注绑定了，也就是说真正执行绑定的是方法<code>resolveArgument</code></p>
<h3 id="resolveArgument"><a href="#resolveArgument" class="headerlink" title="resolveArgument"></a>resolveArgument</h3><p><code>resolveArgument</code>是真正执行绑定的的方法</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Iterate over registered</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> HandlerMethodArgumentResolver HandlerMethodArgumentResolvers&#125;</span><br><span class="hljs-comment"> * and invoke the one that supports it.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> IllegalArgumentException if no suitable argument resolver is found</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">resolveArgument</span><span class="hljs-params">(MethodParameter parameter, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span><br><span class="hljs-params"><span class="hljs-function">  NativeWebRequest webRequest, <span class="hljs-meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br> <span class="hljs-comment">// 获取合适的参数解析器</span><br> HandlerMethodArgumentResolver resolver = getArgumentResolver(parameter);<br> <span class="hljs-keyword">if</span> (resolver == <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Unsupported parameter type [&quot;</span> +<br>    parameter.getParameterType().getName() + <span class="hljs-string">&quot;]. supportsParameter should be called first.&quot;</span>);<br> &#125;<br> <span class="hljs-comment">// 执行参数绑定</span><br> <span class="hljs-keyword">return</span> resolver.resolveArgument(parameter, mavContainer, webRequest, binderFactory);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="getArgumentResolver"><a href="#getArgumentResolver" class="headerlink" title="getArgumentResolver"></a>getArgumentResolver</h3><p><code>getArgumentResolver</code>该方法用于执行参数的绑定，定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Find a registered &#123;<span class="hljs-doctag">@link</span> HandlerMethodArgumentResolver&#125; that supports</span><br><span class="hljs-comment"> * the given method parameter.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> HandlerMethodArgumentResolver <span class="hljs-title">getArgumentResolver</span><span class="hljs-params">(MethodParameter parameter)</span> </span>&#123;<br> HandlerMethodArgumentResolver result = <span class="hljs-keyword">this</span>.argumentResolverCache.get(parameter);<br> <span class="hljs-keyword">if</span> (result == <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-keyword">for</span> (HandlerMethodArgumentResolver resolver : <span class="hljs-keyword">this</span>.argumentResolvers) &#123;<br>   <span class="hljs-keyword">if</span> (resolver.supportsParameter(parameter)) &#123;<br>    result = resolver;<br>    <span class="hljs-keyword">this</span>.argumentResolverCache.put(parameter, result);<br>    <span class="hljs-keyword">break</span>;<br>   &#125;<br>  &#125;<br> &#125;<br> <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></div></td></tr></table></figure>



<p>该方法的逻辑就是先从<code>argumentResolver</code>缓存中找到能够执行参数绑定的<code>HandlerMethodArgumentResolver</code>，如果找不到就从<code>HandlerMethodArgumentResolver</code>找，<code>SpringMVC</code>支持的<code>HandlerMethodArgumentResolver</code>一共有26种，用来解析各种类型的参数</p>
<p><img src="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121551493.webp" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>根据博主的调试可以知道</p>
<ul>
<li><code>RequestParamMethodArgumentResolver</code>：处理普通参数（基本类型、包装类型、<code>String</code>），不管加不加<code>@RequestParam</code>注解</li>
<li><code>ServletModelAttributeMethodProcessor</code>：处理POJO类型的参数，比如自定义的<code>Student</code>对象</li>
<li><code>RequestResponseBodyMethodProcessor</code>：处理<code>@RequestBody</code>注解类型的参数</li>
</ul>
<h3 id="resolveArgument-1"><a href="#resolveArgument-1" class="headerlink" title="resolveArgument"></a>resolveArgument</h3><p>由于不同类型的参数有不同的<code>HandlerMethodArgumentResolver</code>来处理，此处选取POJO类型参数的注入实现，对应的参数解析类是<code>ModelAttributeMethodProcessor</code>，其中<code>resolveArgument</code>方法用来解析（绑定）参数方法定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Resolve the argument from the model or if not found instantiate it with</span><br><span class="hljs-comment"> * its default if it is available. The model attribute is then populated</span><br><span class="hljs-comment"> * with request values via data binding and optionally validated</span><br><span class="hljs-comment"> * if &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@java</span>.validation.Valid&#125; is present on the argument.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> BindException if data binding and validation result in an error</span><br><span class="hljs-comment"> * and the next method parameter is not of type &#123;<span class="hljs-doctag">@link</span> Errors&#125;</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception if WebDataBinder initialization fails</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Object <span class="hljs-title">resolveArgument</span><span class="hljs-params">(MethodParameter parameter, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span><br><span class="hljs-params"><span class="hljs-function">  NativeWebRequest webRequest, <span class="hljs-meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br> Assert.state(mavContainer != <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;ModelAttributeMethodProcessor requires ModelAndViewContainer&quot;</span>);<br> Assert.state(binderFactory != <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;ModelAttributeMethodProcessor requires WebDataBinderFactory&quot;</span>);<br><br> <span class="hljs-comment">// 获取参数名</span><br> String name = ModelFactory.getNameForParameter(parameter);<br> <span class="hljs-comment">// 获取参数上的ModelAttribute注解</span><br> ModelAttribute ann = parameter.getParameterAnnotation(ModelAttribute.class);<br> <span class="hljs-keyword">if</span> (ann != <span class="hljs-keyword">null</span>) &#123;<br>  mavContainer.setBinding(name, ann.binding());<br> &#125;<br><br> Object attribute = <span class="hljs-keyword">null</span>;<br> BindingResult bindingResult = <span class="hljs-keyword">null</span>;<br><br> <span class="hljs-keyword">if</span> (mavContainer.containsAttribute(name)) &#123;<br>  attribute = mavContainer.getModel().get(name);<br> &#125;<br> <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// Create attribute instance</span><br>  <span class="hljs-keyword">try</span> &#123;<br>   <span class="hljs-comment">// 创建参数类型的实例（未注入值），底层就是通过反射调用构造方法</span><br>   attribute = createAttribute(name, parameter, binderFactory, webRequest);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (BindException ex) &#123;<br>   <span class="hljs-keyword">if</span> (isBindExceptionRequired(parameter)) &#123;<br>    <span class="hljs-comment">// No BindingResult parameter -&gt; fail with BindException</span><br>    <span class="hljs-keyword">throw</span> ex;<br>   &#125;<br>   <span class="hljs-comment">// Otherwise, expose null/empty value and associated BindingResult</span><br>   <span class="hljs-keyword">if</span> (parameter.getParameterType() == Optional.class) &#123;<br>    attribute = Optional.empty();<br>   &#125;<br>   bindingResult = ex.getBindingResult();<br>  &#125;<br> &#125;<br><br> <span class="hljs-keyword">if</span> (bindingResult == <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-comment">// Bean property binding and validation;</span><br>  <span class="hljs-comment">// skipped in case of binding failure on construction.</span><br>  WebDataBinder binder = binderFactory.createBinder(webRequest, attribute, name);<br>  <span class="hljs-keyword">if</span> (binder.getTarget() != <span class="hljs-keyword">null</span>) &#123;<br>   <span class="hljs-keyword">if</span> (!mavContainer.isBindingDisabled(name)) &#123;<br>    <span class="hljs-comment">// 真正执行绑定（值注入）的方法</span><br>    bindRequestParameters(binder, webRequest);<br>   &#125;<br>   validateIfApplicable(binder, parameter);<br>   <span class="hljs-keyword">if</span> (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BindException(binder.getBindingResult());<br>   &#125;<br>  &#125;<br>  <span class="hljs-comment">// Value type adaptation, also covering java.util.Optional</span><br>  <span class="hljs-keyword">if</span> (!parameter.getParameterType().isInstance(attribute)) &#123;<br>   attribute = binder.convertIfNecessary(binder.getTarget(), parameter.getParameterType(), parameter);<br>  &#125;<br>  bindingResult = binder.getBindingResult();<br> &#125;<br><br> <span class="hljs-comment">// Add resolved attribute and BindingResult at the end of the model</span><br> Map&lt;String, Object&gt; bindingResultModel = bindingResult.getModel();<br> mavContainer.removeAttributes(bindingResultModel);<br> mavContainer.addAllAttributes(bindingResultModel);<br><br> <span class="hljs-keyword">return</span> attribute;<br>&#125;<br></code></pre></div></td></tr></table></figure>



<p><img src="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121551408.webp" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>根据调试信息也可以看到<code>bindRequestParameters(binder, webRequest)</code>执行完成之后，POJO类型的参数已经完成了绑定。</p>
<h3 id="bindRequestParameters"><a href="#bindRequestParameters" class="headerlink" title="bindRequestParameters"></a>bindRequestParameters</h3><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * This implementation downcasts &#123;<span class="hljs-doctag">@link</span> WebDataBinder&#125; to</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> ServletRequestDataBinder&#125; before binding.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> ServletRequestDataBinderFactory</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bindRequestParameters</span><span class="hljs-params">(WebDataBinder binder, NativeWebRequest request)</span> </span>&#123;<br> ServletRequest servletRequest = request.getNativeRequest(ServletRequest.class);<br> Assert.state(servletRequest != <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;No ServletRequest&quot;</span>);<br> ServletRequestDataBinder servletBinder = (ServletRequestDataBinder) binder;<br> <span class="hljs-comment">// 执行绑定的方法</span><br> servletBinder.bind(servletRequest);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h3><p>继续深入<code>bind</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bind</span><span class="hljs-params">(ServletRequest request)</span> </span>&#123;<br> <span class="hljs-comment">// 获取所有参数的键值对</span><br> MutablePropertyValues mpvs = <span class="hljs-keyword">new</span> ServletRequestParameterPropertyValues(request);<br> <span class="hljs-comment">// 处理文件上传请求</span><br> MultipartRequest multipartRequest = WebUtils.getNativeRequest(request, MultipartRequest.class);<br> <span class="hljs-keyword">if</span> (multipartRequest != <span class="hljs-keyword">null</span>) &#123;<br>  bindMultipart(multipartRequest.getMultiFileMap(), mpvs);<br> &#125;<br> <span class="hljs-comment">// 把url中携带的参数也加入到MutablePropertyValues</span><br> addBindValues(mpvs, request);<br> <span class="hljs-comment">// 执行绑定（注入值）</span><br> doBind(mpvs);<br>&#125;<br></code></pre></div></td></tr></table></figure>



<p>由于调用层次过深，所以无法一步步列出下面的步骤，<code>doBind</code>方法的原理还是通过调用POJO对象里的<code>setter</code>方法设置值，可以查看最终的调试信息</p>
<p><img src="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121551607.webp" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>根据调试信息可以看到，最终执行的还是POJO对象的<code>setter</code>方法，具体执行的类是<code>BeanWrapperImpl</code>。</p>
<p>了解了参数的绑定，再来看返回值的处理。</p>
<h2 id="返回值处理"><a href="#返回值处理" class="headerlink" title="返回值处理"></a><strong>返回值处理</strong></h2><h3 id="invokeAndHandle"><a href="#invokeAndHandle" class="headerlink" title="invokeAndHandle"></a>invokeAndHandle</h3><p>回到源码<code>invokeAndHandle</code>方法处（<code>ServletInvocableHandlerMethod</code>类中），该方法定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Invoke the method and handle the return value through one of the</span><br><span class="hljs-comment"> * configured &#123;<span class="hljs-doctag">@link</span> HandlerMethodReturnValueHandler HandlerMethodReturnValueHandlers&#125;.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> webRequest the current request</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> mavContainer the ModelAndViewContainer for this request</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> providedArgs &quot;given&quot; arguments matched by type (not resolved)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeAndHandle</span><span class="hljs-params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span></span><br><span class="hljs-params"><span class="hljs-function">  Object... providedArgs)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br> Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);<br> setResponseStatus(webRequest);<br><br> <span class="hljs-keyword">if</span> (returnValue == <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-keyword">if</span> (isRequestNotModified(webRequest) || getResponseStatus() != <span class="hljs-keyword">null</span> || mavContainer.isRequestHandled()) &#123;<br>   disableContentCachingIfNecessary(webRequest);<br>   mavContainer.setRequestHandled(<span class="hljs-keyword">true</span>);<br>   <span class="hljs-keyword">return</span>;<br>  &#125;<br> &#125;<br> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.hasText(getResponseStatusReason())) &#123;<br>  mavContainer.setRequestHandled(<span class="hljs-keyword">true</span>);<br>  <span class="hljs-keyword">return</span>;<br> &#125;<br><br> mavContainer.setRequestHandled(<span class="hljs-keyword">false</span>);<br> Assert.state(<span class="hljs-keyword">this</span>.returnValueHandlers != <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;No return value handlers&quot;</span>);<br> <span class="hljs-keyword">try</span> &#123;<br>  <span class="hljs-comment">// 真正处理不同类型返回值的方法</span><br>  <span class="hljs-keyword">this</span>.returnValueHandlers.handleReturnValue(<br>    returnValue, getReturnValueType(returnValue), mavContainer, webRequest);<br> &#125;<br> <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>  <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>   logger.trace(formatErrorForReturnValue(returnValue), ex);<br>  &#125;<br>  <span class="hljs-keyword">throw</span> ex;<br> &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>真正处理不同类型的返回值的方法是<code>handleReturnValue</code>方法</p>
<h3 id="handleReturnValue"><a href="#handleReturnValue" class="headerlink" title="handleReturnValue"></a>handleReturnValue</h3><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Iterate over registered &#123;<span class="hljs-doctag">@link</span> HandlerMethodReturnValueHandler HandlerMethodReturnValueHandlers&#125; and invoke the one that supports it.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> IllegalStateException if no suitable &#123;<span class="hljs-doctag">@link</span> HandlerMethodReturnValueHandler&#125; is found.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleReturnValue</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object returnValue, MethodParameter returnType,</span></span><br><span class="hljs-params"><span class="hljs-function">  ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br> <span class="hljs-comment">// 根据返回值个返回值类型选取合适的HandlerMethodReturnValueHandler</span><br> HandlerMethodReturnValueHandler handler = selectHandler(returnValue, returnType);<br> <span class="hljs-keyword">if</span> (handler == <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Unknown return value type: &quot;</span> + returnType.getParameterType().getName());<br> &#125;<br> <span class="hljs-comment">// 真正的处理返回值</span><br> handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="selectHandler"><a href="#selectHandler" class="headerlink" title="selectHandler"></a>selectHandler</h3><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> HandlerMethodReturnValueHandler <span class="hljs-title">selectHandler</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object value, MethodParameter returnType)</span> </span>&#123;<br> <span class="hljs-keyword">boolean</span> isAsyncValue = isAsyncReturnValue(value, returnType);<br> <span class="hljs-keyword">for</span> (HandlerMethodReturnValueHandler handler : <span class="hljs-keyword">this</span>.returnValueHandlers) &#123;<br>  <span class="hljs-keyword">if</span> (isAsyncValue &amp;&amp; !(handler <span class="hljs-keyword">instanceof</span> AsyncHandlerMethodReturnValueHandler)) &#123;<br>   <span class="hljs-keyword">continue</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (handler.supportsReturnType(returnType)) &#123;<br>   <span class="hljs-keyword">return</span> handler;<br>  &#125;<br> &#125;<br> <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>



<p><img src="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121552660.webp" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>根据调试信息可以看到，<code>SpringMVC</code>为返回值提供了15个<code>HandlerMethodReturnValueHandler</code>的实现了来处理不同类型的返回值。</p>
<p>事实上，用来处理<code>@ResponseBody</code>类型的是<code>RequestResponseBodyMethodProcessor</code>。</p>
<p>如果对前文参数绑定还有印象的话，会发现<code>@RequestBody</code>类型参数绑定也是用的这个类。</p>
<p>继续跟进<code>RequestResponseBodyMethodProcessor</code>类的<code>handleReturnValue</code>方法</p>
<h3 id="handleReturnValue-1"><a href="#handleReturnValue-1" class="headerlink" title="handleReturnValue"></a>handleReturnValue</h3><p><code>RequestResponseBodyMethodProcessor</code>类的<code>handleReturnValue</code>方法定义如下</p>
<blockquote>
<p>这里设置了一个非常重要的属性<code>requestHandled</code>，这个属性关系到是否需要返回<code>ModelAndView</code>对象</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleReturnValue</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object returnValue, MethodParameter returnType,</span></span><br><span class="hljs-params"><span class="hljs-function">  ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span></span><br><span class="hljs-function">  <span class="hljs-keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;<br><br> <span class="hljs-comment">// 设置该请求是否已在处理程序中完全处理，例如@ResponseBody方法不需要视图解析器，此处就可以设置为true。</span><br> <span class="hljs-comment">// 当控制器方法声明类型为ServletResponse或OutputStream的参数时，也可以设置此标志为true。</span><br> <span class="hljs-comment">// 这个属性设置成true之后，上层getModelAndView获取ModelAndView时会返回Null，因为不需要视图。</span><br> <span class="hljs-comment">// 默认值为false</span><br> mavContainer.setRequestHandled(<span class="hljs-keyword">true</span>);<br> ServletServerHttpRequest inputMessage = createInputMessage(webRequest);<br> ServletServerHttpResponse outputMessage = createOutputMessage(webRequest);<br><br> <span class="hljs-comment">// Try even with null return value. ResponseBodyAdvice could get involved.</span><br> <span class="hljs-comment">// 底层就是利用java.io.OutputStreamWriter类把返回值写到网络IO</span><br> writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>继续深入<code>writeWithMessageConverters</code>方法，一步步调试到最后，底层就是利用<code>java.io.OutputStreamWriter</code>类把返回值写到网络IO</p>
<p><img src="https://tuyong.oss-cn-hangzhou.aliyuncs.com/img/202109121552758.webp" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>由于<code>handleReturnValue</code>把<code>requestHandled</code>设置成了<code>true</code>，上层在调用<code>getModelAndView</code>方法时会返回<code>null</code>，表示该请求不需要视图。感兴趣的同学自己调试一下便知。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p>本文主要从源码的阅读和调试的角度，整体的讲解了<code>SpringMVC</code>处理请求的整个流程，并且讲解了参数的绑定以及返回值的处理。相信大家看完后，结合自己的调试信息，会对<code>SpringMVC</code>的请求处理过程有一个更深入的理解。</p>
<hr>
<p>作者：Sicimike；blog.csdn.net/Baisitao_/article/details/107471719</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Java/">Java</a>
                    
                      <a class="hover-with-bg" href="/categories/Java/SpringMVC/">SpringMVC</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                      <a class="hover-with-bg" href="/tags/SpringMVC/">SpringMVC</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/03/25/Spring%20MVC%20%E4%BA%94%E5%A4%A7%E7%BB%84%E4%BB%B6/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Spring MVC 五大组件</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/03/25/Spring%20Data%20Redis/">
                        <span class="hidden-mobile">Spring Data Redis</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://github.com/xiaobeibi" target="_blank" rel="nofollow noopener"><span>Github</span></a> <i class="iconfont icon-love"></i> <a href="https://gitee.com/tytokongjian" target="_blank" rel="nofollow noopener"><span>Gitee</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
