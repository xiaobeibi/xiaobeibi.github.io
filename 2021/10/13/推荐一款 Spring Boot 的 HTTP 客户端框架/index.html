

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon_ico.png">
  <link rel="icon" href="/img/favicon_ico.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="åˆ†äº«æ€»ç»“ä¸ªäººçš„å­¦ä¹ è·¯ç¨‹">
  <meta name="author" content="å± é›">
  <meta name="keywords" content="PCB, å•ç‰‡æœº, ç‰©è”ç½‘, åµŒå…¥å¼, Java, Linux, Webå‰ç«¯">
  <meta name="description" content="æ¨èä¸€æ¬¾ Spring Boot çš„ HTTP å®¢æˆ·ç«¯æ¡†æ¶  åœ¨SpringBooté¡¹ç›®ç›´æ¥ä½¿ç”¨okhttpã€httpClientæˆ–è€…RestTemplateå‘èµ·HTTPè¯·æ±‚ï¼Œæ—¢ç¹çåˆä¸æ–¹ä¾¿ç»Ÿä¸€ç®¡ç†ã€‚ å› æ­¤ï¼Œåœ¨è¿™é‡Œæ¨èä¸€ä¸ªé€‚ç”¨äºSpringBooté¡¹ç›®çš„è½»é‡çº§HTTPå®¢æˆ·ç«¯æ¡†æ¶retrofit-spring-boot-starterï¼Œä½¿ç”¨éå¸¸ç®€å•æ–¹ä¾¿ï¼ŒåŒæ—¶åˆæä¾›è¯¸å¤šåŠŸèƒ½å¢å¼ºã€‚ç›®å‰é¡¹ç›®å·²ç»æ›´æ–°è‡³2.">
<meta property="og:type" content="article">
<meta property="og:title" content="æ¨èä¸€æ¬¾ Spring Boot çš„ HTTP å®¢æˆ·ç«¯æ¡†æ¶">
<meta property="og:url" content="http://example.com/2021/10/13/%E6%8E%A8%E8%8D%90%E4%B8%80%E6%AC%BE%20Spring%20Boot%20%E7%9A%84%20HTTP%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A1%86%E6%9E%B6/index.html">
<meta property="og:site_name" content="å°è´æ¯”">
<meta property="og:description" content="æ¨èä¸€æ¬¾ Spring Boot çš„ HTTP å®¢æˆ·ç«¯æ¡†æ¶  åœ¨SpringBooté¡¹ç›®ç›´æ¥ä½¿ç”¨okhttpã€httpClientæˆ–è€…RestTemplateå‘èµ·HTTPè¯·æ±‚ï¼Œæ—¢ç¹çåˆä¸æ–¹ä¾¿ç»Ÿä¸€ç®¡ç†ã€‚ å› æ­¤ï¼Œåœ¨è¿™é‡Œæ¨èä¸€ä¸ªé€‚ç”¨äºSpringBooté¡¹ç›®çš„è½»é‡çº§HTTPå®¢æˆ·ç«¯æ¡†æ¶retrofit-spring-boot-starterï¼Œä½¿ç”¨éå¸¸ç®€å•æ–¹ä¾¿ï¼ŒåŒæ—¶åˆæä¾›è¯¸å¤šåŠŸèƒ½å¢å¼ºã€‚ç›®å‰é¡¹ç›®å·²ç»æ›´æ–°è‡³2.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/tytokongjian/image/raw/master/images/202108301550308.png">
<meta property="article:published_time" content="2021-10-13T14:16:55.456Z">
<meta property="article:modified_time" content="2021-10-13T10:58:18.570Z">
<meta property="article:author" content="å± é›">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="SpringBoot">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://gitee.com/tytokongjian/image/raw/master/images/202108301550308.png">
  
  <title>æ¨èä¸€æ¬¾ Spring Boot çš„ HTTP å®¢æˆ·ç«¯æ¡†æ¶ - å°è´æ¯”</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/atom-one-dark.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>å°è´æ¯”çš„ä¸ªäººåšå®¢</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/background7.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="æ¨èä¸€æ¬¾ Spring Boot çš„ HTTP å®¢æˆ·ç«¯æ¡†æ¶">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-10-13 22:16" pubdate>
        2021å¹´10æœˆ13æ—¥ æ™šä¸Š
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      18k å­—
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      56 åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">æ¨èä¸€æ¬¾ Spring Boot çš„ HTTP å®¢æˆ·ç«¯æ¡†æ¶</h1>
            
            <div class="markdown-body">
              <center><h2>æ¨èä¸€æ¬¾ Spring Boot çš„ HTTP å®¢æˆ·ç«¯æ¡†æ¶</h2></center>

<p>åœ¨SpringBooté¡¹ç›®ç›´æ¥ä½¿ç”¨okhttpã€httpClientæˆ–è€…RestTemplateå‘èµ·HTTPè¯·æ±‚ï¼Œæ—¢ç¹çåˆä¸æ–¹ä¾¿ç»Ÿä¸€ç®¡ç†ã€‚</p>
<p>å› æ­¤ï¼Œåœ¨è¿™é‡Œæ¨èä¸€ä¸ªé€‚ç”¨äº<code>SpringBoot</code>é¡¹ç›®çš„è½»é‡çº§HTTPå®¢æˆ·ç«¯æ¡†æ¶retrofit-spring-boot-starterï¼Œä½¿ç”¨éå¸¸ç®€å•æ–¹ä¾¿ï¼ŒåŒæ—¶åˆæä¾›è¯¸å¤šåŠŸèƒ½å¢å¼ºã€‚ç›®å‰é¡¹ç›®å·²ç»æ›´æ–°è‡³<code>2.2.2</code>ç‰ˆæœ¬ï¼Œå¹¶ä¸”ä¼šæŒç»­è¿›è¡Œè¿­ä»£ä¼˜åŒ–ã€‚</p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a><strong>å‰è¨€</strong></h2><p><code>Retrofit</code>æ˜¯é€‚ç”¨äº<code>Android</code>å’Œ<code>Java</code>ä¸”ç±»å‹å®‰å…¨çš„HTTPå®¢æˆ·ç«¯ï¼Œå…¶æœ€å¤§çš„ç‰¹æ€§çš„æ˜¯æ”¯æŒé€šè¿‡æ¥å£çš„æ–¹å¼å‘èµ·HTTPè¯·æ±‚ ã€‚è€Œspring-bootæ˜¯ä½¿ç”¨æœ€å¹¿æ³›çš„Javaå¼€å‘æ¡†æ¶ï¼Œä½†æ˜¯Retrofitå®˜æ–¹æ²¡æœ‰æ”¯æŒä¸spring-bootæ¡†æ¶å¿«é€Ÿæ•´åˆï¼Œå› æ­¤æˆ‘ä»¬å¼€å‘äº†retrofit-spring-boot-starterã€‚</p>
<p><strong>retrofit-spring-boot-starterå®ç°äº†Retrofitä¸spring-bootæ¡†æ¶å¿«é€Ÿæ•´åˆï¼Œå¹¶ä¸”æ”¯æŒäº†è¯¸å¤šåŠŸèƒ½å¢å¼ºï¼Œæå¤§ç®€åŒ–å¼€å‘</strong> ã€‚</p>
<p>ğŸš€é¡¹ç›®æŒç»­ä¼˜åŒ–è¿­ä»£ã€‚</p>
<p><strong>åŠŸèƒ½ç‰¹æ€§</strong></p>
<ul>
<li>è‡ªå®šä¹‰æ³¨å…¥OkHttpClient</li>
<li>æ³¨è§£å¼æ‹¦æˆªå™¨</li>
<li>è¿æ¥æ± ç®¡ç†</li>
<li>æ—¥å¿—æ‰“å°</li>
<li>è¯·æ±‚é‡è¯•</li>
<li>é”™è¯¯è§£ç å™¨</li>
<li>å…¨å±€æ‹¦æˆªå™¨</li>
<li>ç†”æ–­é™çº§</li>
<li>å¾®æœåŠ¡ä¹‹é—´çš„HTTPè°ƒç”¨</li>
<li>è°ƒç”¨é€‚é…å™¨</li>
<li>æ•°æ®è½¬æ¢å™¨</li>
</ul>
<h3 id="å¿«é€Ÿä½¿ç”¨"><a href="#å¿«é€Ÿä½¿ç”¨" class="headerlink" title="å¿«é€Ÿä½¿ç”¨"></a><strong>å¿«é€Ÿä½¿ç”¨</strong></h3><h4 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.lianjiatech<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>retrofit-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<h4 id="å®šä¹‰httpæ¥å£"><a href="#å®šä¹‰httpæ¥å£" class="headerlink" title="å®šä¹‰httpæ¥å£"></a>å®šä¹‰httpæ¥å£</h4><p><strong>æ¥å£å¿…é¡»ä½¿ç”¨</strong>@RetrofitClient`æ³¨è§£æ ‡è®° ï¼httpç›¸å…³æ³¨è§£å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šretrofitå®˜æ–¹æ–‡æ¡£ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@RetrofitClient(baseUrl = &quot;$&#123;test.baseUrl&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HttpApi</span> </span>&#123;<br><br>    <span class="hljs-meta">@GET(&quot;person&quot;)</span><br>    <span class="hljs-function">Result&lt;Person&gt; <span class="hljs-title">getPerson</span><span class="hljs-params">(<span class="hljs-meta">@Query(&quot;id&quot;)</span> Long id)</span></span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="æ³¨å…¥ä½¿ç”¨"><a href="#æ³¨å…¥ä½¿ç”¨" class="headerlink" title="æ³¨å…¥ä½¿ç”¨"></a>æ³¨å…¥ä½¿ç”¨</h4><p><strong>å°†æ¥å£æ³¨å…¥åˆ°å…¶å®ƒServiceä¸­å³å¯ä½¿ç”¨ï¼</strong></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HttpApi httpApi;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// é€šè¿‡httpApiå‘èµ·httpè¯·æ±‚</span><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="HTTPè¯·æ±‚ç›¸å…³æ³¨è§£"><a href="#HTTPè¯·æ±‚ç›¸å…³æ³¨è§£" class="headerlink" title="HTTPè¯·æ±‚ç›¸å…³æ³¨è§£"></a><strong>HTTPè¯·æ±‚ç›¸å…³æ³¨è§£</strong></h2><p><code>HTTP</code>è¯·æ±‚ç›¸å…³æ³¨è§£ï¼Œå…¨éƒ¨ä½¿ç”¨äº†<code>retrofit</code>åŸç”Ÿæ³¨è§£ã€‚<strong>è¯¦ç»†ä¿¡æ¯å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šretrofitå®˜æ–¹æ–‡æ¡£</strong> ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•è¯´æ˜ã€‚</p>
<table>
<thead>
<tr>
<th><strong>æ³¨è§£åˆ†ç±»</strong></th>
<th><strong>æ”¯æŒçš„æ³¨è§£</strong></th>
</tr>
</thead>
<tbody><tr>
<td>è¯·æ±‚æ–¹å¼</td>
<td><code>@GET</code> <code>@HEAD</code> <code>@POST</code> <code>@PUT</code> <code>@DELETE</code> <code>@OPTIONS</code></td>
</tr>
<tr>
<td>è¯·æ±‚å¤´</td>
<td><code>@Header</code> <code>@HeaderMap</code> <code>@Headers</code></td>
</tr>
<tr>
<td>Queryå‚æ•°</td>
<td><code>@Query</code> <code>@QueryMap</code> <code>@QueryName</code></td>
</tr>
<tr>
<td>pathå‚æ•°</td>
<td><code>@Path</code></td>
</tr>
<tr>
<td>form-encodedå‚æ•°</td>
<td><code>@Field</code> <code>@FieldMap</code> <code>@FormUrlEncoded</code></td>
</tr>
<tr>
<td>æ–‡ä»¶ä¸Šä¼ </td>
<td><code>@Multipart</code> <code>@Part</code> <code>@PartMap</code></td>
</tr>
<tr>
<td>urlå‚æ•°</td>
<td><code>@Url</code></td>
</tr>
</tbody></table>
<h2 id="é…ç½®é¡¹è¯´æ˜"><a href="#é…ç½®é¡¹è¯´æ˜" class="headerlink" title="é…ç½®é¡¹è¯´æ˜"></a><strong>é…ç½®é¡¹è¯´æ˜</strong></h2><p>retrofit-spring-boot-starteræ”¯æŒäº†å¤šä¸ªå¯é…ç½®çš„å±æ€§ï¼Œç”¨æ¥åº”å¯¹ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€‚æ‚¨å¯ä»¥è§†æƒ…å†µè¿›è¡Œä¿®æ”¹ï¼Œå…·ä½“è¯´æ˜å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>é…ç½®</th>
<th>é»˜è®¤å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>enable-log</td>
<td>true</td>
<td>å¯ç”¨æ—¥å¿—æ‰“å°</td>
</tr>
<tr>
<td>logging-interceptor</td>
<td>DefaultLoggingInterceptor</td>
<td>æ—¥å¿—æ‰“å°æ‹¦æˆªå™¨</td>
</tr>
<tr>
<td>pool</td>
<td></td>
<td>è¿æ¥æ± é…ç½®</td>
</tr>
<tr>
<td>disable-void-return-type</td>
<td>false</td>
<td>ç¦ç”¨java.lang.Voidè¿”å›ç±»å‹</td>
</tr>
<tr>
<td>retry-interceptor</td>
<td>DefaultRetryInterceptor</td>
<td>è¯·æ±‚é‡è¯•æ‹¦æˆªå™¨</td>
</tr>
<tr>
<td>global-converter-factories</td>
<td>JacksonConverterFactory</td>
<td>å…¨å±€è½¬æ¢å™¨å·¥å‚</td>
</tr>
<tr>
<td>global-call-adapter-factories</td>
<td>BodyCallAdapterFactory,ResponseCallAdapterFactory</td>
<td>å…¨å±€è°ƒç”¨é€‚é…å™¨å·¥å‚</td>
</tr>
<tr>
<td>enable-degrade</td>
<td>false</td>
<td>æ˜¯å¦å¯ç”¨ç†”æ–­é™çº§</td>
</tr>
<tr>
<td>degrade-type</td>
<td>sentinel</td>
<td>ç†”æ–­é™çº§å®ç°æ–¹å¼(ç›®å‰ä»…æ”¯æŒSentinel)</td>
</tr>
<tr>
<td>resource-name-parser</td>
<td>DefaultResourceNameParser</td>
<td>ç†”æ–­èµ„æºåç§°è§£æå™¨ï¼Œç”¨äºè§£æèµ„æºåç§°</td>
</tr>
</tbody></table>
<p><code>yml</code>é…ç½®æ–¹å¼ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">retrofit:</span><br>  <span class="hljs-attr">enable-response-call-adapter:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-comment"># å¯ç”¨æ—¥å¿—æ‰“å°</span><br>  <span class="hljs-attr">enable-log:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-comment"># è¿æ¥æ± é…ç½®</span><br>  <span class="hljs-attr">pool:</span><br>    <span class="hljs-attr">test1:</span><br>      <span class="hljs-attr">max-idle-connections:</span> <span class="hljs-number">3</span><br>      <span class="hljs-attr">keep-alive-second:</span> <span class="hljs-number">100</span><br>    <span class="hljs-attr">test2:</span><br>      <span class="hljs-attr">max-idle-connections:</span> <span class="hljs-number">5</span><br>      <span class="hljs-attr">keep-alive-second:</span> <span class="hljs-number">50</span><br>  <span class="hljs-comment"># ç¦ç”¨voidè¿”å›å€¼ç±»å‹</span><br>  <span class="hljs-attr">disable-void-return-type:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-comment"># æ—¥å¿—æ‰“å°æ‹¦æˆªå™¨</span><br>  <span class="hljs-attr">logging-interceptor:</span> <span class="hljs-string">com.github.lianjiatech.retrofit.spring.boot.interceptor.DefaultLoggingInterceptor</span><br>  <span class="hljs-comment"># è¯·æ±‚é‡è¯•æ‹¦æˆªå™¨</span><br>  <span class="hljs-attr">retry-interceptor:</span> <span class="hljs-string">com.github.lianjiatech.retrofit.spring.boot.retry.DefaultRetryInterceptor</span><br>  <span class="hljs-comment"># å…¨å±€è½¬æ¢å™¨å·¥å‚</span><br>  <span class="hljs-attr">global-converter-factories:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">retrofit2.converter.jackson.JacksonConverterFactory</span><br>  <span class="hljs-comment"># å…¨å±€è°ƒç”¨é€‚é…å™¨å·¥å‚</span><br>  <span class="hljs-attr">global-call-adapter-factories:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">com.github.lianjiatech.retrofit.spring.boot.core.BodyCallAdapterFactory</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">com.github.lianjiatech.retrofit.spring.boot.core.ResponseCallAdapterFactory</span><br>  <span class="hljs-comment"># æ˜¯å¦å¯ç”¨ç†”æ–­é™çº§</span><br>  <span class="hljs-attr">enable-degrade:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-comment"># ç†”æ–­é™çº§å®ç°æ–¹å¼</span><br>  <span class="hljs-attr">degrade-type:</span> <span class="hljs-string">sentinel</span><br>  <span class="hljs-comment"># ç†”æ–­èµ„æºåç§°è§£æå™¨</span><br>  <span class="hljs-attr">resource-name-parser:</span> <span class="hljs-string">com.github.lianjiatech.retrofit.spring.boot.degrade.DefaultResourceNameParser</span><br></code></pre></div></td></tr></table></figure>

<h2 id="é«˜çº§åŠŸèƒ½"><a href="#é«˜çº§åŠŸèƒ½" class="headerlink" title="é«˜çº§åŠŸèƒ½"></a><strong>é«˜çº§åŠŸèƒ½</strong></h2><h3 id="è‡ªå®šä¹‰æ³¨å…¥OkHttpClient"><a href="#è‡ªå®šä¹‰æ³¨å…¥OkHttpClient" class="headerlink" title="è‡ªå®šä¹‰æ³¨å…¥OkHttpClient"></a><strong>è‡ªå®šä¹‰æ³¨å…¥OkHttpClient</strong></h3><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œé€šè¿‡<code>@RetrofitClient</code>æ³¨è§£å±æ€§åŠ¨æ€åˆ›å»º<code>OkHttpClient</code>å¯¹è±¡èƒ½å¤Ÿæ»¡è¶³å¤§éƒ¨åˆ†ä½¿ç”¨åœºæ™¯ã€‚ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦è‡ªå®šä¹‰<code>OkHttpClient</code>ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥åœ¨æ¥å£ä¸Šå®šä¹‰è¿”å›ç±»å‹æ˜¯<code>OkHttpClient.Builder</code>çš„é™æ€æ–¹æ³•æ¥å®ç°ã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@RetrofitClient(baseUrl = &quot;http://ke.com&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HttpApi3</span> </span>&#123;<br><br>    <span class="hljs-meta">@OkHttpClientBuilder</span><br>    <span class="hljs-keyword">static</span> OkHttpClient.<span class="hljs-function">Builder <span class="hljs-title">okhttpClientBuilder</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> OkHttpClient.Builder()<br>                .connectTimeout(<span class="hljs-number">1</span>, TimeUnit.SECONDS)<br>                .readTimeout(<span class="hljs-number">1</span>, TimeUnit.SECONDS)<br>                .writeTimeout(<span class="hljs-number">1</span>, TimeUnit.SECONDS);<br><br>    &#125;<br><br>    <span class="hljs-meta">@GET</span><br>    <span class="hljs-function">Result&lt;Person&gt; <span class="hljs-title">getPerson</span><span class="hljs-params">(<span class="hljs-meta">@Url</span> String url, <span class="hljs-meta">@Query(&quot;id&quot;)</span> Long id)</span></span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<blockquote>
<p>æ–¹æ³•å¿…é¡»ä½¿ç”¨<code>@OkHttpClientBuilder</code>æ³¨è§£æ ‡è®°ï¼</p>
</blockquote>
<h4 id="æ³¨è§£å¼æ‹¦æˆªå™¨"><a href="#æ³¨è§£å¼æ‹¦æˆªå™¨" class="headerlink" title="æ³¨è§£å¼æ‹¦æˆªå™¨"></a>æ³¨è§£å¼æ‹¦æˆªå™¨</h4><p>å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›æŸä¸ªæ¥å£ä¸‹çš„æŸäº›httpè¯·æ±‚æ‰§è¡Œç»Ÿä¸€çš„æ‹¦æˆªå¤„ç†é€»è¾‘ã€‚ä¸ºäº†æ”¯æŒè¿™ä¸ªåŠŸèƒ½ï¼Œ<code>retrofit-spring-boot-starter</code>æä¾›äº†<strong>æ³¨è§£å¼æ‹¦æˆªå™¨</strong> ï¼Œåšåˆ°äº†<strong>åŸºäºurlè·¯å¾„çš„åŒ¹é…æ‹¦æˆª</strong> ã€‚ä½¿ç”¨çš„æ­¥éª¤ä¸»è¦åˆ†ä¸º2æ­¥ï¼š</p>
<ol>
<li><p>ç»§æ‰¿<code>BasePathMatchInterceptor</code>ç¼–å†™æ‹¦æˆªå¤„ç†å™¨ï¼›</p>
</li>
<li><p>æ¥å£ä¸Šä½¿ç”¨<code>@Intercept</code>è¿›è¡Œæ ‡æ³¨ã€‚å¦‚éœ€é…ç½®å¤šä¸ªæ‹¦æˆªå™¨ï¼Œåœ¨æ¥å£ä¸Šæ ‡æ³¨å¤šä¸ª<code>@Intercept</code>æ³¨è§£å³å¯ï¼</p>
</li>
</ol>
<p>ä¸‹é¢ä»¥<em>ç»™æŒ‡å®šè¯·æ±‚çš„urlåé¢æ‹¼æ¥timestampæ—¶é—´æˆ³</em>ä¸ºä¾‹ï¼Œä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨æ³¨è§£å¼æ‹¦æˆªå™¨ã€‚</p>
<p><strong>ç»§æ‰¿</strong><code>BasePathMatchInterceptor</code><strong>ç¼–å†™æ‹¦æˆªå¤„ç†å™¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TimeStampInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BasePathMatchInterceptor</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">doIntercept</span><span class="hljs-params">(Chain chain)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        Request request = chain.request();<br>        HttpUrl url = request.url();<br>        <span class="hljs-keyword">long</span> timestamp = System.currentTimeMillis();<br>        HttpUrl newUrl = url.newBuilder()<br>                .addQueryParameter(<span class="hljs-string">&quot;timestamp&quot;</span>, String.valueOf(timestamp))<br>                .build();<br>        Request newRequest = request.newBuilder()<br>                .url(newUrl)<br>                .build();<br>        <span class="hljs-keyword">return</span> chain.proceed(newRequest);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p><strong>æ¥å£ä¸Šä½¿ç”¨ <code>@Intercept </code>è¿›è¡Œæ ‡æ³¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@RetrofitClient(baseUrl = &quot;$&#123;test.baseUrl&#125;&quot;)</span><br><span class="hljs-meta">@Intercept(handler = TimeStampInterceptor.class, include = &#123;&quot;/api/**&quot;&#125;, exclude = &quot;/api/test/savePerson&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HttpApi</span> </span>&#123;<br><br>    <span class="hljs-meta">@GET(&quot;person&quot;)</span><br>    <span class="hljs-function">Result&lt;Person&gt; <span class="hljs-title">getPerson</span><span class="hljs-params">(<span class="hljs-meta">@Query(&quot;id&quot;)</span> Long id)</span></span>;<br><br>    <span class="hljs-meta">@POST(&quot;savePerson&quot;)</span><br>    <span class="hljs-function">Result&lt;Person&gt; <span class="hljs-title">savePerson</span><span class="hljs-params">(<span class="hljs-meta">@Body</span> Person person)</span></span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>ä¸Šé¢çš„<code>@Intercept</code>é…ç½®è¡¨ç¤ºï¼šæ‹¦æˆª<code>HttpApi</code>æ¥å£ä¸‹<code>/api/**</code>è·¯å¾„ä¸‹ï¼ˆæ’é™¤<code>/api/test/savePerson</code>ï¼‰çš„è¯·æ±‚ï¼Œæ‹¦æˆªå¤„ç†å™¨ä½¿ç”¨<code>TimeStampInterceptor</code>ã€‚</p>
<h4 id="æ‰©å±•æ³¨è§£å¼æ‹¦æˆªå™¨"><a href="#æ‰©å±•æ³¨è§£å¼æ‹¦æˆªå™¨" class="headerlink" title="æ‰©å±•æ³¨è§£å¼æ‹¦æˆªå™¨"></a><strong>æ‰©å±•æ³¨è§£å¼æ‹¦æˆªå™¨</strong></h4><p>æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨<strong>æ‹¦æˆªæ³¨è§£</strong>åŠ¨æ€ä¼ å…¥ä¸€äº›å‚æ•°ï¼Œç„¶åå†æ‰§è¡Œæ‹¦æˆªçš„æ—¶å€™éœ€è¦ä½¿ç”¨è¿™ä¸ªå‚æ•°ã€‚è¿™ç§æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ‰©å±•å®ç°<strong>è‡ªå®šä¹‰æ‹¦æˆªæ³¨è§£</strong> ã€‚<code>è‡ªå®šä¹‰æ‹¦æˆªæ³¨è§£</code>å¿…é¡»ä½¿ç”¨<code>@InterceptMark</code>æ ‡è®°ï¼Œå¹¶ä¸”æ³¨è§£ä¸­å¿…é¡»åŒ…æ‹¬<strong>include()ã€exclude()ã€handler()å±æ€§ä¿¡æ¯</strong> ã€‚ä½¿ç”¨çš„æ­¥éª¤ä¸»è¦åˆ†ä¸º3æ­¥ï¼š</p>
<ol>
<li><p>è‡ªå®šä¹‰æ‹¦æˆªæ³¨è§£</p>
</li>
<li><p>ç»§æ‰¿BasePathMatchInterceptorç¼–å†™æ‹¦æˆªå¤„ç†å™¨</p>
</li>
<li><p>æ¥å£ä¸Šä½¿ç”¨è‡ªå®šä¹‰æ‹¦æˆªæ³¨è§£ï¼›</p>
</li>
</ol>
<p>ä¾‹å¦‚æˆ‘ä»¬éœ€è¦<strong>åœ¨è¯·æ±‚å¤´é‡Œé¢åŠ¨æ€åŠ å…¥</strong><code>accessKeyId</code>ã€<code>accessKeySecret</code>ç­¾åä¿¡æ¯æ‰èƒ½æ­£å¸¸å‘èµ·httpè¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªåŠ ç­¾æ‹¦æˆªå™¨æ³¨è§£<code>@Sign</code>æ¥å®ç° ã€‚ä¸‹é¢ä»¥è‡ªå®šä¹‰<code>@Sign</code>æ‹¦æˆªæ³¨è§£ä¸ºä¾‹è¿›è¡Œè¯´æ˜ã€‚</p>
<p><strong>è‡ªå®šä¹‰</strong><code>@Sign</code><strong>æ³¨è§£</strong></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@InterceptMark</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Sign &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¯†é’¥key</span><br><span class="hljs-comment">     * æ”¯æŒå ä½ç¬¦å½¢å¼é…ç½®ã€‚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">String <span class="hljs-title">accessKeyId</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¯†é’¥</span><br><span class="hljs-comment">     * æ”¯æŒå ä½ç¬¦å½¢å¼é…ç½®ã€‚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">String <span class="hljs-title">accessKeySecret</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ‹¦æˆªå™¨åŒ¹é…è·¯å¾„</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    String[] include() <span class="hljs-keyword">default</span> &#123;<span class="hljs-string">&quot;/**&quot;</span>&#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ‹¦æˆªå™¨æ’é™¤åŒ¹é…ï¼Œæ’é™¤æŒ‡å®šè·¯å¾„æ‹¦æˆª</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    String[] exclude() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¤„ç†è¯¥æ³¨è§£çš„æ‹¦æˆªå™¨ç±»</span><br><span class="hljs-comment">     * ä¼˜å…ˆä»springå®¹å™¨è·å–å¯¹åº”çš„Beanï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™ä½¿ç”¨åå°„åˆ›å»ºä¸€ä¸ªï¼</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    Class&lt;? extends BasePathMatchInterceptor&gt; handler() <span class="hljs-keyword">default</span> SignInterceptor.class;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>æ‰©å±•è‡ªå®šä¹‰æ‹¦æˆªæ³¨è§£æœ‰ä»¥ä¸‹2ç‚¹éœ€è¦æ³¨æ„ï¼š</p>
<ol>
<li><p>è‡ªå®šä¹‰æ‹¦æˆªæ³¨è§£å¿…é¡»ä½¿ç”¨@InterceptMarkæ ‡è®°ã€‚</p>
</li>
<li><p>æ³¨è§£ä¸­å¿…é¡»åŒ…æ‹¬include()ã€exclude()ã€handler()å±æ€§ä¿¡æ¯ã€‚</p>
</li>
</ol>
<p><strong>å®ç°SignInterceptor</strong></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SignInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BasePathMatchInterceptor</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> String accessKeyId;<br><br>    <span class="hljs-keyword">private</span> String accessKeySecret;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAccessKeyId</span><span class="hljs-params">(String accessKeyId)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.accessKeyId = accessKeyId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAccessKeySecret</span><span class="hljs-params">(String accessKeySecret)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.accessKeySecret = accessKeySecret;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">doIntercept</span><span class="hljs-params">(Chain chain)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        Request request = chain.request();<br>        Request newReq = request.newBuilder()<br>                .addHeader(<span class="hljs-string">&quot;accessKeyId&quot;</span>, accessKeyId)<br>                .addHeader(<span class="hljs-string">&quot;accessKeySecret&quot;</span>, accessKeySecret)<br>                .build();<br>        <span class="hljs-keyword">return</span> chain.proceed(newReq);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>ä¸Šè¿°<code>accessKeyId</code>å’Œ<code>accessKeySecret</code>å­—æ®µå€¼ä¼šä¾æ®<code>@Sign</code>æ³¨è§£çš„<code>accessKeyId()</code>å’Œ<code>accessKeySecret()</code>å€¼è‡ªåŠ¨æ³¨å…¥ï¼Œå¦‚æœ<code>@Sign</code>æŒ‡å®šçš„æ˜¯å ä½ç¬¦å½¢å¼çš„å­—ç¬¦ä¸²ï¼Œåˆ™ä¼šå–é…ç½®å±æ€§å€¼è¿›è¡Œæ³¨å…¥ ã€‚å¦å¤–ï¼Œ<code>accessKeyId</code>å’Œ<code>accessKeySecret</code>å­—æ®µå¿…é¡»æä¾›<code>setter</code>æ–¹æ³• ã€‚</p>
<p><strong>æ¥å£ä¸Šä½¿ç”¨</strong>@Sign</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@RetrofitClient(baseUrl = &quot;$&#123;test.baseUrl&#125;&quot;)</span><br><span class="hljs-meta">@Sign(accessKeyId = &quot;$&#123;test.accessKeyId&#125;&quot;, accessKeySecret = &quot;$&#123;test.accessKeySecret&#125;&quot;, exclude = &#123;&quot;/api/test/person&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HttpApi</span> </span>&#123;<br><br>    <span class="hljs-meta">@GET(&quot;person&quot;)</span><br>    <span class="hljs-function">Result&lt;Person&gt; <span class="hljs-title">getPerson</span><span class="hljs-params">(<span class="hljs-meta">@Query(&quot;id&quot;)</span> Long id)</span></span>;<br><br>    <span class="hljs-meta">@POST(&quot;savePerson&quot;)</span><br>    <span class="hljs-function">Result&lt;Person&gt; <span class="hljs-title">savePerson</span><span class="hljs-params">(<span class="hljs-meta">@Body</span> Person person)</span></span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>è¿™æ ·å°±èƒ½åœ¨æŒ‡å®šurlçš„è¯·æ±‚ä¸Šï¼Œè‡ªåŠ¨åŠ ä¸Šç­¾åä¿¡æ¯äº†ã€‚</p>
<h4 id="è¿æ¥æ± ç®¡ç†"><a href="#è¿æ¥æ± ç®¡ç†" class="headerlink" title="è¿æ¥æ± ç®¡ç†"></a><strong>è¿æ¥æ± ç®¡ç†</strong></h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰é€šè¿‡<code>Retrofit</code>å‘é€çš„httpè¯·æ±‚éƒ½ä¼šä½¿ç”¨<code>max-idle-connections=5 keep-alive-second=300</code>çš„é»˜è®¤è¿æ¥æ± ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®å¤šä¸ªè‡ªå®šä¹‰çš„è¿æ¥æ± ï¼Œç„¶åé€šè¿‡<code>@RetrofitClient</code>çš„<code>poolName</code>å±æ€§æ¥æŒ‡å®šä½¿ç”¨ã€‚æ¯”å¦‚æˆ‘ä»¬è¦è®©æŸä¸ªæ¥å£ä¸‹çš„è¯·æ±‚å…¨éƒ¨ä½¿ç”¨<code>poolName=test1</code>çš„è¿æ¥æ± ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<ol>
<li>é…ç½®è¿æ¥æ± ã€‚</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">retrofit:</span><br>   <span class="hljs-comment"># è¿æ¥æ± é…ç½®</span><br>   <span class="hljs-attr">pool:</span><br>       <span class="hljs-attr">test1:</span><br>       <span class="hljs-attr">max-idle-connections:</span> <span class="hljs-number">3</span><br>       <span class="hljs-attr">keep-alive-second:</span> <span class="hljs-number">100</span><br>       <span class="hljs-attr">test2:</span><br>       <span class="hljs-attr">max-idle-connections:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">keep-alive-second:</span> <span class="hljs-number">50</span><br></code></pre></div></td></tr></table></figure>

<ol start="2">
<li>é€šè¿‡<code>@RetrofitClient</code>çš„<code>poolName</code>å±æ€§æ¥æŒ‡å®šä½¿ç”¨çš„è¿æ¥æ± ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@RetrofitClient(baseUrl = &quot;$&#123;test.baseUrl&#125;&quot;, poolName=&quot;test1&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HttpApi</span> </span>&#123;<br>    <span class="hljs-meta">@GET(&quot;person&quot;)</span><br>    <span class="hljs-function">Result&lt;Person&gt; <span class="hljs-title">getPerson</span><span class="hljs-params">(<span class="hljs-meta">@Query(&quot;id&quot;)</span> Long id)</span></span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="æ—¥å¿—æ‰“å°"><a href="#æ—¥å¿—æ‰“å°" class="headerlink" title="æ—¥å¿—æ‰“å°"></a>æ—¥å¿—æ‰“å°</h4><p>å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›å°†httpè¯·æ±‚æ—¥å¿—è®°å½•ä¸‹æ¥ã€‚é€šè¿‡retrofit.enableLogé…ç½®å¯ä»¥å…¨å±€æ§åˆ¶æ—¥å¿—æ˜¯å¦å¼€å¯ã€‚é’ˆå¯¹æ¯ä¸ªæ¥å£ï¼Œå¯ä»¥é€šè¿‡@RetrofitClientçš„enableLogæ§åˆ¶æ˜¯å¦å¼€å¯ï¼Œé€šè¿‡logLevelå’ŒlogStrategyï¼Œå¯ä»¥æŒ‡å®šæ¯ä¸ªæ¥å£çš„æ—¥å¿—æ‰“å°çº§åˆ«ä»¥åŠæ—¥å¿—æ‰“å°ç­–ç•¥ã€‚retrofit-spring-boot-starteræ”¯æŒäº†5ç§æ—¥å¿—æ‰“å°çº§åˆ«(<code>ERROR</code>, <code>WARN</code>, <code>INFO</code>, <code>DEBUG</code>, <code>TRACE</code>)ï¼Œé»˜è®¤<code>INFO</code>ï¼›æ”¯æŒäº†4ç§æ—¥å¿—æ‰“å°ç­–ç•¥ï¼ˆ<code>NONE</code>, <code>BASIC</code>, <code>HEADERS</code>, <code>BODY</code>ï¼‰ï¼Œé»˜è®¤<code>BASIC</code>ã€‚4ç§æ—¥å¿—æ‰“å°ç­–ç•¥å«ä¹‰å¦‚ä¸‹ï¼š</p>
<p><code>1. NONE</code>ï¼šNo logs.</p>
<p><code>2. BASIC</code>ï¼šLogs request and response lines.</p>
<p><code>3. HEADERS</code>ï¼šLogs request and response lines and their respective headers.</p>
<p><code>4. BODY</code>ï¼šLogs request and response lines and their respective headers and bodies (if present).</p>
<p><code>retrofit-spring-boot-starter</code>é»˜è®¤ä½¿ç”¨äº†<code>DefaultLoggingInterceptor</code>æ‰§è¡ŒçœŸæ­£çš„æ—¥å¿—æ‰“å°åŠŸèƒ½ï¼Œå…¶åº•å±‚å°±æ˜¯<code>okhttp</code>åŸç”Ÿçš„<code>HttpLoggingInterceptor</code>ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å®ç°è‡ªå·±çš„æ—¥å¿—æ‰“å°æ‹¦æˆªå™¨ï¼Œåªéœ€è¦ç»§æ‰¿<code>BaseLoggingInterceptor</code>ï¼ˆå…·ä½“å¯ä»¥å‚è€ƒ<code>DefaultLoggingInterceptor</code>çš„å®ç°ï¼‰ï¼Œç„¶ååœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œç›¸å…³é…ç½®å³å¯ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">retrofit:</span><br>  <span class="hljs-comment"># æ—¥å¿—æ‰“å°æ‹¦æˆªå™¨</span><br>  <span class="hljs-attr">logging-interceptor:</span> <span class="hljs-string">com.github.lianjiatech.retrofit.spring.boot.interceptor.DefaultLoggingInterceptor</span><br></code></pre></div></td></tr></table></figure>

<h4 id="è¯·æ±‚é‡è¯•"><a href="#è¯·æ±‚é‡è¯•" class="headerlink" title="è¯·æ±‚é‡è¯•"></a>è¯·æ±‚é‡è¯•</h4><p><code>retrofit-spring-boot-starter</code>æ”¯æŒè¯·æ±‚é‡è¯•åŠŸèƒ½ï¼Œåªéœ€è¦åœ¨æ¥å£æˆ–è€…æ–¹æ³•ä¸ŠåŠ ä¸Š<code>@Retry</code>æ³¨è§£å³å¯ã€‚**<code>@Retry</code>æ”¯æŒé‡è¯•æ¬¡æ•°<code>maxRetries</code>ã€é‡è¯•æ—¶é—´é—´éš”<code>intervalMs</code>ä»¥åŠé‡è¯•è§„åˆ™<code>retryRules</code>é…ç½®** ã€‚</p>
<p>é‡è¯•è§„åˆ™æ”¯æŒä¸‰ç§é…ç½®ï¼š</p>
<p><code>1. RESPONSE_STATUS_NOT_2XX</code>ï¼šå“åº”çŠ¶æ€ç ä¸æ˜¯<code>2xx</code>æ—¶æ‰§è¡Œé‡è¯•ï¼›</p>
<p><code>2. OCCUR_IO_EXCEPTION</code>ï¼šå‘ç”ŸIOå¼‚å¸¸æ—¶æ‰§è¡Œé‡è¯•ï¼›</p>
<p><code>3. OCCUR_EXCEPTION</code>ï¼šå‘ç”Ÿä»»æ„å¼‚å¸¸æ—¶æ‰§è¡Œé‡è¯•ï¼›</p>
<p>é»˜è®¤å“åº”çŠ¶æ€ç ä¸æ˜¯<code>2xx</code>æˆ–è€…å‘ç”ŸIOå¼‚å¸¸æ—¶è‡ªåŠ¨è¿›è¡Œé‡è¯•ã€‚éœ€è¦çš„è¯ï¼Œä½ ä¹Ÿå¯ä»¥ç»§æ‰¿<code>BaseRetryInterceptor</code>å®ç°è‡ªå·±çš„è¯·æ±‚é‡è¯•æ‹¦æˆªå™¨ï¼Œç„¶åå°†å…¶é…ç½®ä¸Šå»ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">retrofit:</span><br><span class="hljs-comment"># è¯·æ±‚é‡è¯•æ‹¦æˆªå™¨</span><br><span class="hljs-attr">retry-interceptor:</span> <span class="hljs-string">com.github.lianjiatech.retrofit.spring.boot.retry.DefaultRetryInterceptor</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://gitee.com/tytokongjian/image/raw/master/images/202108301550308.png" srcset="/img/loading.gif" lazyload alt="Javaåç«¯"></p>
<h4 id="é”™è¯¯è§£ç å™¨"><a href="#é”™è¯¯è§£ç å™¨" class="headerlink" title="é”™è¯¯è§£ç å™¨"></a><strong>é”™è¯¯è§£ç å™¨</strong></h4><p>åœ¨<code>HTTP</code>å‘ç”Ÿè¯·æ±‚é”™è¯¯(åŒ…æ‹¬å‘ç”Ÿå¼‚å¸¸æˆ–è€…å“åº”æ•°æ®ä¸ç¬¦åˆé¢„æœŸ)çš„æ—¶å€™ï¼Œé”™è¯¯è§£ç å™¨å¯å°†<code>HTTP</code>ç›¸å…³ä¿¡æ¯è§£ç åˆ°è‡ªå®šä¹‰å¼‚å¸¸ä¸­ã€‚ä½ å¯ä»¥åœ¨<code>@RetrofitClient</code>æ³¨è§£çš„<code>errorDecoder()</code>æŒ‡å®šå½“å‰æ¥å£çš„é”™è¯¯è§£ç å™¨ï¼Œè‡ªå®šä¹‰é”™è¯¯è§£ç å™¨éœ€è¦å®ç°<code>ErrorDecoder</code>æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * é”™è¯¯è§£ç å™¨ã€‚ErrorDecoder.</span><br><span class="hljs-comment"> * å½“è¯·æ±‚å‘ç”Ÿå¼‚å¸¸æˆ–è€…æ”¶åˆ°æ— æ•ˆå“åº”ç»“æœçš„æ—¶å€™ï¼Œå°†HTTPç›¸å…³ä¿¡æ¯è§£ç åˆ°å¼‚å¸¸ä¸­ï¼Œæ— æ•ˆå“åº”ç”±ä¸šåŠ¡è‡ªå·±åˆ¤æ–­</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * When an exception occurs in the request or an invalid response result is received, the HTTP related information is decoded into the exception,</span><br><span class="hljs-comment"> * and the invalid response is determined by the business itself.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> é™ˆæ·»æ˜</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ErrorDecoder</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å½“æ— æ•ˆå“åº”çš„æ—¶å€™ï¼Œå°†HTTPä¿¡æ¯è§£ç åˆ°å¼‚å¸¸ä¸­ï¼Œæ— æ•ˆå“åº”ç”±ä¸šåŠ¡è‡ªè¡Œåˆ¤æ–­ã€‚</span><br><span class="hljs-comment">     * When the response is invalid, decode the HTTP information into the exception, invalid response is determined by business.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request  request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> If it returns null, the processing is ignored and the processing continues with the original response.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> RuntimeException <span class="hljs-title">invalidRespDecode</span><span class="hljs-params">(Request request, Response response)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!response.isSuccessful()) &#123;<br>            <span class="hljs-keyword">throw</span> RetrofitException.errorStatus(request, response);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å½“è¯·æ±‚å‘ç”ŸIOå¼‚å¸¸æ—¶ï¼Œå°†HTTPä¿¡æ¯è§£ç åˆ°å¼‚å¸¸ä¸­ã€‚</span><br><span class="hljs-comment">     * When an IO exception occurs in the request, the HTTP information is decoded into the exception.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cause   IOException</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> RuntimeException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> RuntimeException <span class="hljs-title">ioExceptionDecode</span><span class="hljs-params">(Request request, IOException cause)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> RetrofitException.errorExecuting(request, cause);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å½“è¯·æ±‚å‘ç”Ÿé™¤IOå¼‚å¸¸ä¹‹å¤–çš„å…¶å®ƒå¼‚å¸¸æ—¶ï¼Œå°†HTTPä¿¡æ¯è§£ç åˆ°å¼‚å¸¸ä¸­ã€‚</span><br><span class="hljs-comment">     * When the request has an exception other than the IO exception, the HTTP information is decoded into the exception.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cause   Exception</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> RuntimeException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> RuntimeException <span class="hljs-title">exceptionDecode</span><span class="hljs-params">(Request request, Exception cause)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> RetrofitException.errorUnknown(request, cause);<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="å…¨å±€æ‹¦æˆªå™¨"><a href="#å…¨å±€æ‹¦æˆªå™¨" class="headerlink" title="å…¨å±€æ‹¦æˆªå™¨"></a><strong>å…¨å±€æ‹¦æˆªå™¨</strong></h2><h4 id="å…¨å±€åº”ç”¨æ‹¦æˆªå™¨"><a href="#å…¨å±€åº”ç”¨æ‹¦æˆªå™¨" class="headerlink" title="å…¨å±€åº”ç”¨æ‹¦æˆªå™¨"></a>å…¨å±€åº”ç”¨æ‹¦æˆªå™¨</h4><p>å¦‚æœæˆ‘ä»¬éœ€è¦å¯¹æ•´ä¸ªç³»ç»Ÿçš„çš„httpè¯·æ±‚æ‰§è¡Œç»Ÿä¸€çš„æ‹¦æˆªå¤„ç†ï¼Œå¯ä»¥è‡ªå®šä¹‰å®ç°å…¨å±€æ‹¦æˆªå™¨<code>BaseGlobalInterceptor</code>, å¹¶é…ç½®æˆ<code>spring</code>å®¹å™¨ä¸­çš„<code>bean</code>ï¼ä¾‹å¦‚æˆ‘ä»¬éœ€è¦åœ¨æ•´ä¸ªç³»ç»Ÿå‘èµ·çš„httpè¯·æ±‚ï¼Œéƒ½å¸¦ä¸Šæ¥æºä¿¡æ¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SourceInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseGlobalInterceptor</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">doIntercept</span><span class="hljs-params">(Chain chain)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        Request request = chain.request();<br>        Request newReq = request.newBuilder()<br>                .addHeader(<span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>)<br>                .build();<br>        <span class="hljs-keyword">return</span> chain.proceed(newReq);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="å…¨å±€ç½‘ç»œæ‹¦æˆªå™¨"><a href="#å…¨å±€ç½‘ç»œæ‹¦æˆªå™¨" class="headerlink" title="å…¨å±€ç½‘ç»œæ‹¦æˆªå™¨"></a>å…¨å±€ç½‘ç»œæ‹¦æˆªå™¨</h4><p>åªéœ€è¦å®ç°<code>NetworkInterceptor</code>æ¥å£ å¹¶é…ç½®æˆ<code>spring</code>å®¹å™¨ä¸­çš„<code>bean</code>å°±æ”¯æŒè‡ªåŠ¨ç»‡å…¥å…¨å±€ç½‘ç»œæ‹¦æˆªå™¨ã€‚</p>
<h4 id="ç†”æ–­é™çº§"><a href="#ç†”æ–­é™çº§" class="headerlink" title="ç†”æ–­é™çº§"></a>ç†”æ–­é™çº§</h4><p>åœ¨åˆ†å¸ƒå¼æœåŠ¡æ¶æ„ä¸­ï¼Œå¯¹ä¸ç¨³å®šçš„å¤–éƒ¨æœåŠ¡è¿›è¡Œç†”æ–­é™çº§æ˜¯ä¿è¯æœåŠ¡é«˜å¯ç”¨çš„é‡è¦æªæ–½ä¹‹ä¸€ã€‚ç”±äºå¤–éƒ¨æœåŠ¡çš„ç¨³å®šæ€§æ˜¯ä¸èƒ½ä¿è¯çš„ï¼Œå½“å¤–éƒ¨æœåŠ¡ä¸ç¨³å®šæ—¶ï¼Œå“åº”æ—¶é—´ä¼šå˜é•¿ã€‚ç›¸åº”åœ°ï¼Œè°ƒç”¨æ–¹çš„å“åº”æ—¶é—´ä¹Ÿä¼šå˜é•¿ï¼Œçº¿ç¨‹ä¼šäº§ç”Ÿå †ç§¯ï¼Œæœ€ç»ˆå¯èƒ½è€—å°½è°ƒç”¨æ–¹çš„çº¿ç¨‹æ± ï¼Œå¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸å¯ç”¨ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å¯¹ä¸ç¨³å®šçš„å¼±ä¾èµ–æœåŠ¡è°ƒç”¨è¿›è¡Œç†”æ–­é™çº§ï¼Œæš‚æ—¶åˆ‡æ–­ä¸ç¨³å®šè°ƒç”¨ï¼Œé¿å…å±€éƒ¨ä¸ç¨³å®šå¯¼è‡´æ•´ä½“æœåŠ¡é›ªå´©ã€‚</p>
<p><code>retrofit-spring-boot-starter</code>æ”¯æŒç†”æ–­é™çº§åŠŸèƒ½ï¼Œåº•å±‚åŸºäºSentinelå®ç°ã€‚å…·ä½“æ¥è¯´ï¼Œæ”¯æŒäº†<strong>ç†”æ–­èµ„æºè‡ªå‘ç°</strong> å’Œ<strong>æ³¨è§£å¼é™çº§è§„åˆ™é…ç½®</strong> ã€‚å¦‚éœ€ä½¿ç”¨ç†”æ–­é™çº§ï¼Œåªéœ€è¦è¿›è¡Œä»¥ä¸‹æ“ä½œå³å¯ï¼š</p>
<ol>
<li>å¼€å¯ç†”æ–­é™çº§åŠŸèƒ½</li>
</ol>
<p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œç†”æ–­é™çº§åŠŸèƒ½æ˜¯å…³é—­çš„ï¼Œéœ€è¦è®¾ç½®ç›¸åº”çš„é…ç½®é¡¹æ¥å¼€å¯ç†”æ–­é™çº§åŠŸèƒ½</strong> ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">retrofit:</span><br><span class="hljs-comment"># æ˜¯å¦å¯ç”¨ç†”æ–­é™çº§</span><br><span class="hljs-attr">enable-degrade:</span> <span class="hljs-literal">true</span><br><span class="hljs-comment"># ç†”æ–­é™çº§å®ç°æ–¹å¼(ç›®å‰ä»…æ”¯æŒSentinel)</span><br><span class="hljs-attr">degrade-type:</span> <span class="hljs-string">sentinel</span><br><span class="hljs-comment"># èµ„æºåç§°è§£æå™¨</span><br><span class="hljs-attr">resource-name-parser:</span> <span class="hljs-string">com.github.lianjiatech.retrofit.spring.boot.degrade.DefaultResourceNameParser</span><br></code></pre></div></td></tr></table></figure>

<p>èµ„æºåç§°è§£æå™¨ç”¨äºå®ç°ç”¨æˆ·è‡ªå®šä¹‰èµ„æºåç§°ï¼Œé»˜è®¤é…ç½®æ˜¯<code>DefaultResourceNameParser</code>ï¼Œå¯¹åº”çš„èµ„æºåç§°æ ¼å¼ä¸º<code>HTTP_OUT:GET:http://localhost:8080/api/degrade/test</code>ã€‚ç”¨æˆ·å¯ä»¥ç»§æ‰¿<code>BaseResourceNameParser</code>ç±»å®ç°è‡ªå·±çš„èµ„æºåç§°è§£æå™¨ã€‚</p>
<p>å¦å¤–ï¼Œç”±äºç†”æ–­é™çº§åŠŸèƒ½æ˜¯å¯é€‰çš„ï¼Œ<strong>å› æ­¤å¯ç”¨ç†”æ–­é™çº§éœ€è¦ç”¨æˆ·è‡ªè¡Œå¼•å…¥Sentinelä¾èµ–</strong> ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.csp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sentinel-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<ol start="2">
<li>é…ç½®é™çº§è§„åˆ™ï¼ˆå¯é€‰ï¼‰</li>
</ol>
<p><strong><code>retrofit-spring-boot-starter</code>æ”¯æŒæ³¨è§£å¼é…ç½®é™çº§è§„åˆ™ï¼Œé€šè¿‡<code>@Degrade</code>æ³¨è§£æ¥é…ç½®é™çº§è§„åˆ™</strong> ã€‚<code>@Degrade</code>æ³¨è§£å¯ä»¥é…ç½®åœ¨æ¥å£æˆ–è€…æ–¹æ³•ä¸Šï¼Œé…ç½®åœ¨æ–¹æ³•ä¸Šçš„ä¼˜å…ˆçº§æ›´é«˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Degrade &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * RT threshold or exception ratio threshold count.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">count</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Degrade recover timeout (in seconds) when degradation occurs.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">timeWindow</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> 5</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Degrade strategy (0: average RT, 1: exception ratio).</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">DegradeStrategy <span class="hljs-title">degradeStrategy</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> DegradeStrategy.AVERAGE_RT</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<blockquote>
<p><strong>å¦‚æœåº”ç”¨é¡¹ç›®å·²æ”¯æŒé€šè¿‡é…ç½®ä¸­å¿ƒé…ç½®é™çº§è§„åˆ™ï¼Œå¯å¿½ç•¥æ³¨è§£å¼é…ç½®æ–¹å¼</strong> ã€‚</p>
</blockquote>
<ol start="3">
<li>@RetrofitClientè®¾ç½®fallbackæˆ–è€…fallbackFactory (å¯é€‰)</li>
</ol>
<p>å¦‚æœ<code>@RetrofitClient</code>ä¸è®¾ç½®<code>fallback</code>æˆ–è€…<code>fallbackFactory</code>ï¼Œå½“è§¦å‘ç†”æ–­æ—¶ï¼Œä¼šç›´æ¥æŠ›å‡º<code>RetrofitBlockException</code>å¼‚å¸¸ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡è®¾ç½®<code>fallback</code>æˆ–è€…<code>fallbackFactory</code>æ¥å®šåˆ¶ç†”æ–­æ—¶çš„æ–¹æ³•è¿”å›å€¼ ã€‚</p>
<p><code>fallback</code>ç±»å¿…é¡»æ˜¯å½“å‰æ¥å£çš„å®ç°ç±»ï¼Œ<code>fallbackFactory</code>å¿…é¡»æ˜¯<code>FallbackFactory&lt;T&gt;</code>å®ç°ç±»ï¼Œæ³›å‹å‚æ•°ç±»å‹ä¸ºå½“å‰æ¥å£ç±»å‹ã€‚å¦å¤–ï¼Œ<code>fallback</code>å’Œ<code>fallbackFactory</code>å®ä¾‹å¿…é¡»é…ç½®æˆ<code>Spring</code>å®¹å™¨çš„<code>Bean</code>ã€‚</p>
<p><strong><code>fallbackFactory</code>ç›¸å¯¹äº<code>fallback</code>ï¼Œä¸»è¦å·®åˆ«åœ¨äºèƒ½å¤Ÿæ„ŸçŸ¥æ¯æ¬¡ç†”æ–­çš„å¼‚å¸¸åŸå› (cause)</strong> ã€‚å‚è€ƒç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpDegradeFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HttpDegradeApi</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Integer&gt; <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br>        Result&lt;Integer&gt; fallback = <span class="hljs-keyword">new</span> Result&lt;&gt;();<br>        fallback.setCode(<span class="hljs-number">100</span>)<br>                .setMsg(<span class="hljs-string">&quot;fallback&quot;</span>)<br>                .setBody(<span class="hljs-number">1000000</span>);<br>        <span class="hljs-keyword">return</span> fallback;<br>    &#125;<br>&#125;<br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpDegradeFallbackFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FallbackFactory</span>&lt;<span class="hljs-title">HttpDegradeApi</span>&gt; </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns an instance of the fallback appropriate for the given cause</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cause fallback cause</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> å®ç°äº†retrofitæ¥å£çš„å®ä¾‹ã€‚an instance that implements the retrofit interface.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> HttpDegradeApi <span class="hljs-title">create</span><span class="hljs-params">(Throwable cause)</span> </span>&#123;<br>        log.error(<span class="hljs-string">&quot;è§¦å‘ç†”æ–­äº†! &quot;</span>, cause.getMessage(), cause);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HttpDegradeApi() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Integer&gt; <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br>                Result&lt;Integer&gt; fallback = <span class="hljs-keyword">new</span> Result&lt;&gt;();<br>                fallback.setCode(<span class="hljs-number">100</span>)<br>                        .setMsg(<span class="hljs-string">&quot;fallback&quot;</span>)<br>                        .setBody(<span class="hljs-number">1000000</span>);<br>                <span class="hljs-keyword">return</span> fallback;<br>            &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="å¾®æœåŠ¡ä¹‹é—´çš„HTTPè°ƒç”¨"><a href="#å¾®æœåŠ¡ä¹‹é—´çš„HTTPè°ƒç”¨" class="headerlink" title="å¾®æœåŠ¡ä¹‹é—´çš„HTTPè°ƒç”¨"></a>å¾®æœåŠ¡ä¹‹é—´çš„HTTPè°ƒç”¨</h4><p>ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨å¾®æœåŠ¡è°ƒç”¨ï¼Œéœ€è¦è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š</p>
<p><strong>é…ç½®</strong><code>ServiceInstanceChooser</code><strong>ä¸º</strong><code>Spring</code><strong>å®¹å™¨</strong><code>Bean</code></p>
<p>ç”¨æˆ·å¯ä»¥è‡ªè¡Œå®ç°<code>ServiceInstanceChooser</code>æ¥å£ï¼Œå®ŒæˆæœåŠ¡å®ä¾‹çš„é€‰å–é€»è¾‘ï¼Œå¹¶å°†å…¶é…ç½®æˆ<code>Spring</code>å®¹å™¨çš„<code>Bean</code>ã€‚å¯¹äº<code>Spring Cloud</code>åº”ç”¨ï¼Œ<code>retrofit-spring-boot-starter</code>æä¾›äº†<code>SpringCloudServiceInstanceChooser</code>å®ç°ï¼Œç”¨æˆ·åªéœ€å°†å…¶é…ç½®æˆ<code>Spring</code>çš„<code>Bean</code>å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> ServiceInstanceChooser <span class="hljs-title">serviceInstanceChooser</span><span class="hljs-params">(LoadBalancerClient loadBalancerClient)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SpringCloudServiceInstanceChooser(loadBalancerClient);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p><strong>ä½¿ç”¨<code>@Retrofit</code>çš„<code>serviceId</code>å’Œ<code>path</code>å±æ€§ï¼Œå¯ä»¥å®ç°å¾®æœåŠ¡ä¹‹é—´çš„HTTPè°ƒç”¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@RetrofitClient(serviceId = &quot;$&#123;jy-helicarrier-api.serviceId&#125;&quot;, path = &quot;/m/count&quot;, errorDecoder = HelicarrierErrorDecoder.class)</span><br><span class="hljs-meta">@Retry</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ApiCountService</span> </span>&#123;<br><br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="è°ƒç”¨é€‚é…å™¨å’Œæ•°æ®è½¬ç å™¨"><a href="#è°ƒç”¨é€‚é…å™¨å’Œæ•°æ®è½¬ç å™¨" class="headerlink" title="è°ƒç”¨é€‚é…å™¨å’Œæ•°æ®è½¬ç å™¨"></a><strong>è°ƒç”¨é€‚é…å™¨å’Œæ•°æ®è½¬ç å™¨</strong></h2><h4 id="è°ƒç”¨é€‚é…å™¨"><a href="#è°ƒç”¨é€‚é…å™¨" class="headerlink" title="è°ƒç”¨é€‚é…å™¨"></a>è°ƒç”¨é€‚é…å™¨</h4><p><code>Retrofit</code>å¯ä»¥é€šè¿‡è°ƒç”¨é€‚é…å™¨<code>CallAdapterFactory</code>å°†<code>Call&lt;T&gt;</code>å¯¹è±¡é€‚é…æˆæ¥å£æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ã€‚<code>retrofit-spring-boot-starter</code>æ‰©å±•2ç§<code>CallAdapterFactory</code>å®ç°ï¼š</p>
<figure class="highlight ebnf"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ebnf"><span class="hljs-attribute">BodyCallAdapterFactory</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li>é»˜è®¤å¯ç”¨ï¼Œå¯é€šè¿‡é…ç½®<code>retrofit.enable-body-call-adapter=false</code>å…³é—­</li>
<li>åŒæ­¥æ‰§è¡Œhttpè¯·æ±‚ï¼Œå°†å“åº”ä½“å†…å®¹é€‚é…æˆæ¥å£æ–¹æ³•çš„è¿”å›å€¼ç±»å‹å®ä¾‹ã€‚</li>
<li>é™¤äº†<code>Retrofit.Call&lt;T&gt;</code>ã€<code>Retrofit.Response&lt;T&gt;</code>ã€<code>java.util.concurrent.CompletableFuture&lt;T&gt;</code>ä¹‹å¤–ï¼Œå…¶å®ƒè¿”å›ç±»å‹éƒ½å¯ä»¥ä½¿ç”¨è¯¥é€‚é…å™¨ã€‚</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ebnf"><span class="hljs-attribute">ResponseCallAdapterFactory</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li>é»˜è®¤å¯ç”¨ï¼Œå¯é€šè¿‡é…ç½®<code>retrofit.enable-response-call-adapter=false</code>å…³é—­</li>
<li>åŒæ­¥æ‰§è¡Œhttpè¯·æ±‚ï¼Œå°†å“åº”ä½“å†…å®¹é€‚é…æˆ<code>Retrofit.Response&lt;T&gt;</code>è¿”å›ã€‚</li>
<li>å¦‚æœæ–¹æ³•çš„è¿”å›å€¼ç±»å‹ä¸º<code>Retrofit.Response&lt;T&gt;</code>ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è¯¥é€‚é…å™¨ã€‚</li>
</ul>
<p><strong>Retrofitè‡ªåŠ¨æ ¹æ®æ–¹æ³•è¿”å›å€¼ç±»å‹é€‰ç”¨å¯¹åº”çš„</strong><code>CallAdapterFactory</code>æ‰§è¡Œé€‚é…å¤„ç†ï¼åŠ ä¸ŠRetrofité»˜è®¤çš„<code>CallAdapterFactory</code>ï¼Œå¯æ”¯æŒå¤šç§å½¢å¼çš„æ–¹æ³•è¿”å›å€¼ç±»å‹ï¼š</p>
<ul>
<li><code>Call&lt;T&gt;</code>: ä¸æ‰§è¡Œé€‚é…å¤„ç†ï¼Œç›´æ¥è¿”å›<code>Call&lt;T&gt;</code>å¯¹è±¡</li>
<li><code>CompletableFuture&lt;T&gt;</code>: å°†å“åº”ä½“å†…å®¹é€‚é…æˆ<code>CompletableFuture&lt;T&gt;</code>å¯¹è±¡è¿”å›</li>
<li><code>Void</code>: ä¸å…³æ³¨è¿”å›ç±»å‹å¯ä»¥ä½¿ç”¨<code>Void</code>ã€‚å¦‚æœhttpçŠ¶æ€ç ä¸æ˜¯2xxï¼Œç›´æ¥æŠ›é”™ï¼</li>
<li><code>Response&lt;T&gt;</code>: å°†å“åº”å†…å®¹é€‚é…æˆ<code>Response&lt;T&gt;</code>å¯¹è±¡è¿”å›</li>
<li>å…¶ä»–ä»»æ„Javaç±»å‹ï¼šå°†å“åº”ä½“å†…å®¹é€‚é…æˆä¸€ä¸ªå¯¹åº”çš„Javaç±»å‹å¯¹è±¡è¿”å›ï¼Œå¦‚æœhttpçŠ¶æ€ç ä¸æ˜¯2xxï¼Œç›´æ¥æŠ›é”™ï¼</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Call&lt;T&gt;</span><br><span class="hljs-comment"> * ä¸æ‰§è¡Œé€‚é…å¤„ç†ï¼Œç›´æ¥è¿”å›Call&lt;T&gt;å¯¹è±¡</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GET(&quot;person&quot;)</span><br>Call&lt;Result&lt;Person&gt;&gt; getPersonCall(<span class="hljs-meta">@Query(&quot;id&quot;)</span> Long id);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  CompletableFuture&lt;T&gt;</span><br><span class="hljs-comment"> *  å°†å“åº”ä½“å†…å®¹é€‚é…æˆCompletableFuture&lt;T&gt;å¯¹è±¡è¿”å›</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GET(&quot;person&quot;)</span><br>CompletableFuture&lt;Result&lt;Person&gt;&gt; getPersonCompletableFuture(<span class="hljs-meta">@Query(&quot;id&quot;)</span> Long id);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Void</span><br><span class="hljs-comment"> * ä¸å…³æ³¨è¿”å›ç±»å‹å¯ä»¥ä½¿ç”¨Voidã€‚å¦‚æœhttpçŠ¶æ€ç ä¸æ˜¯2xxï¼Œç›´æ¥æŠ›é”™ï¼</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GET(&quot;person&quot;)</span><br><span class="hljs-function">Void <span class="hljs-title">getPersonVoid</span><span class="hljs-params">(<span class="hljs-meta">@Query(&quot;id&quot;)</span> Long id)</span></span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  Response&lt;T&gt;</span><br><span class="hljs-comment"> *  å°†å“åº”å†…å®¹é€‚é…æˆResponse&lt;T&gt;å¯¹è±¡è¿”å›</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GET(&quot;person&quot;)</span><br>Response&lt;Result&lt;Person&gt;&gt; getPersonResponse(<span class="hljs-meta">@Query(&quot;id&quot;)</span> Long id);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å…¶ä»–ä»»æ„Javaç±»å‹</span><br><span class="hljs-comment"> * å°†å“åº”ä½“å†…å®¹é€‚é…æˆä¸€ä¸ªå¯¹åº”çš„Javaç±»å‹å¯¹è±¡è¿”å›ï¼Œå¦‚æœhttpçŠ¶æ€ç ä¸æ˜¯2xxï¼Œç›´æ¥æŠ›é”™ï¼</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GET(&quot;person&quot;)</span><br><span class="hljs-function">Result&lt;Person&gt; <span class="hljs-title">getPerson</span><span class="hljs-params">(<span class="hljs-meta">@Query(&quot;id&quot;)</span> Long id)</span></span>;<br></code></pre></div></td></tr></table></figure>

<p><strong>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç»§æ‰¿</strong><code>CallAdapter.Factory</code>æ‰©å±•å®ç°è‡ªå·±çš„<code>CallAdapter</code> ï¼</p>
<p><code>retrofit-spring-boot-starter</code>æ”¯æŒé€šè¿‡<code>retrofit.global-call-adapter-factories</code>é…ç½®å…¨å±€è°ƒç”¨é€‚é…å™¨å·¥å‚ï¼Œå·¥å‚å®ä¾‹ä¼˜å…ˆä»Springå®¹å™¨è·å–ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™åå°„åˆ›å»ºã€‚é»˜è®¤çš„å…¨å±€è°ƒç”¨é€‚é…å™¨å·¥å‚æ˜¯<code>[BodyCallAdapterFactory, ResponseCallAdapterFactory]</code>ï¼</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">retrofit:</span><br>  <span class="hljs-comment"># å…¨å±€è°ƒç”¨é€‚é…å™¨å·¥å‚</span><br>  <span class="hljs-attr">global-call-adapter-factories:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">com.github.lianjiatech.retrofit.spring.boot.core.BodyCallAdapterFactory</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">com.github.lianjiatech.retrofit.spring.boot.core.ResponseCallAdapterFactory</span><br></code></pre></div></td></tr></table></figure>

<p>é’ˆå¯¹æ¯ä¸ªJavaæ¥å£ï¼Œè¿˜å¯ä»¥é€šè¿‡<code>@RetrofitClient</code>æ³¨è§£çš„<code>callAdapterFactories()</code>æŒ‡å®šå½“å‰æ¥å£é‡‡ç”¨çš„<code>CallAdapter.Factory</code>ï¼ŒæŒ‡å®šçš„å·¥å‚å®ä¾‹ä¾ç„¶ä¼˜å…ˆä»Springå®¹å™¨è·å–ã€‚</p>
<p><strong>æ³¨æ„ï¼šå¦‚æœ</strong><code>CallAdapter.Factory</code>æ²¡æœ‰<code>public</code>çš„æ— å‚æ„é€ å™¨ï¼Œè¯·æ‰‹åŠ¨å°†å…¶é…ç½®æˆ<code>Spring</code>å®¹å™¨çš„<code>Bean</code>å¯¹è±¡ï¼</p>
<p><strong>æ•°æ®è½¬ç å™¨</strong></p>
<p><code>Retrofit</code>ä½¿ç”¨<code>Converter</code>å°†<code>@Body</code>æ³¨è§£æ ‡æ³¨çš„å¯¹è±¡è½¬æ¢æˆè¯·æ±‚ä½“ï¼Œå°†å“åº”ä½“æ•°æ®è½¬æ¢æˆä¸€ä¸ª<code>Java</code>å¯¹è±¡ï¼Œå¯ä»¥é€‰ç”¨ä»¥ä¸‹å‡ ç§<code>Converter</code>ï¼š</p>
<ul>
<li>Gson: com.squareup.Retrofit:converter-gson</li>
<li>Jackson: com.squareup.Retrofit:converter-jackson</li>
<li>Moshi: com.squareup.Retrofit:converter-moshi</li>
<li>Protobuf: com.squareup.Retrofit:converter-protobuf</li>
<li>Wire: com.squareup.Retrofit:converter-wire</li>
<li>Simple XML: com.squareup.Retrofit:converter-simplexml</li>
<li>JAXB: com.squareup.retrofit2:converter-jaxb</li>
</ul>
<p><code>retrofit-spring-boot-starter</code>æ”¯æŒé€šè¿‡<code>retrofit.global-converter-factories</code>é…ç½®å…¨å±€æ•°æ®è½¬æ¢å™¨å·¥å‚ï¼Œè½¬æ¢å™¨å·¥å‚å®ä¾‹ä¼˜å…ˆä»Springå®¹å™¨è·å–ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™åå°„åˆ›å»ºã€‚</p>
<p>é»˜è®¤çš„å…¨å±€æ•°æ®è½¬æ¢å™¨å·¥å‚æ˜¯<code>retrofit2.converter.jackson.JacksonConverterFactory</code>ï¼Œä½ å¯ä»¥ç›´æ¥é€šè¿‡<code>spring.jackson.*</code>é…ç½®<code>jackson</code>åºåˆ—åŒ–è§„åˆ™ï¼Œé…ç½®å¯å‚è€ƒCustomize the Jackson ObjectMapperï¼</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">retrofit:</span><br>  <span class="hljs-comment"># å…¨å±€è½¬æ¢å™¨å·¥å‚</span><br>  <span class="hljs-attr">global-converter-factories:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">retrofit2.converter.jackson.JacksonConverterFactory</span><br></code></pre></div></td></tr></table></figure>

<p>é’ˆå¯¹æ¯ä¸ªJavaæ¥å£ï¼Œè¿˜å¯ä»¥é€šè¿‡<code>@RetrofitClient</code>æ³¨è§£çš„<code>converterFactories()</code>æŒ‡å®šå½“å‰æ¥å£é‡‡ç”¨çš„<code>Converter.Factory</code>ï¼ŒæŒ‡å®šçš„è½¬æ¢å™¨å·¥å‚å®ä¾‹ä¾ç„¶ä¼˜å…ˆä»Springå®¹å™¨è·å–ã€‚</p>
<p><strong>æ³¨æ„ï¼šå¦‚æœ</strong><code>Converter.Factory</code>æ²¡æœ‰<code>public</code>çš„æ— å‚æ„é€ å™¨ï¼Œè¯·æ‰‹åŠ¨å°†å…¶é…ç½®æˆ<code>Spring</code>å®¹å™¨çš„<code>Bean</code>å¯¹è±¡ ï¼</p>
<p><strong>æ€»ç»“</strong></p>
<p><code>retrofit-spring-boot-starter</code>ä¸€ä¸ªé€‚ç”¨äº<code>SpringBoot</code>é¡¹ç›®çš„è½»é‡çº§<code>HTTP</code>å®¢æˆ·ç«¯æ¡†æ¶ï¼Œå·²åœ¨çº¿ä¸Šç¨³å®šè¿è¡Œä¸¤å¹´å¤šï¼Œå¹¶ä¸”å·²ç»æœ‰å¤šä¸ªå¤–éƒ¨å…¬å¸ä¹Ÿæ¥å…¥ä½¿ç”¨ã€‚</p>
<p>æ¥æºï¼šjuejin.cn/post/6898485806587969544</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Java/">Java</a>
                    
                      <a class="hover-with-bg" href="/categories/Java/SpringBoot/">SpringBoot</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                      <a class="hover-with-bg" href="/tags/SpringBoot/">SpringBoot</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/10/13/40%20%E4%B8%AA%20Spring%20Boot%20%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">40 ä¸ª Spring Boot å¸¸ç”¨æ³¨è§£</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/10/13/SpringBoot+SpringSecurity%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%20+%20Jwt%20%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/">
                        <span class="hidden-mobile">SpringBoot+SpringSecurity å‰åç«¯åˆ†ç¦» + Jwt çš„æƒé™è®¤è¯</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://github.com/xiaobeibi" target="_blank" rel="nofollow noopener"><span>Github</span></a> <i class="iconfont icon-love"></i> <a href="https://gitee.com/tytokongjian" target="_blank" rel="nofollow noopener"><span>Gitee</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- ä¸è’œå­ç»Ÿè®¡PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="busuanzi_value_site_pv"></span>
             æ¬¡
          </span>
      
      
        <!-- ä¸è’œå­ç»Ÿè®¡UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="busuanzi_value_site_uv"></span>
             äºº
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>


</body>
</html>
